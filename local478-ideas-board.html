<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Local 478 Ideas Pipeline</title>
  <meta name="description" content="IATSE Local 478 Ideas Pipeline - Collaborative idea tracking board">
  <meta name="theme-color" content="#0f172a">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üí°</text></svg>">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            slate: {
              750: '#293548',
              850: '#172033',
            }
          }
        }
      }
    }
  </script>
  <style>
    * { box-sizing: border-box; }
    body { background-color: #0f172a; color: #f1f5f9; font-family: system-ui, -apple-system, sans-serif; }
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #1e293b; }
    ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #64748b; }
    .modal-backdrop { animation: fadeIn 150ms ease-out; }
    .modal-content { animation: slideUp 200ms ease-out; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideUp { from { opacity: 0; transform: translateY(20px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
    @keyframes successPulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    .success-pulse { animation: successPulse 300ms ease-out; }
    .blocked-glow { box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.5), 0 0 20px rgba(239, 68, 68, 0.2); }
    .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
  </style>
</head>
<body class="min-h-screen">
  <!-- ==================== CONFIGURATION ==================== -->
  <script>
    const CONFIG = {
      JSONBIN_BIN_ID: '696a2156ae596e708fe050ec',
      JSONBIN_API_KEY: '$2a$10$XMpqAlVtxHtkomcE8HMRxevGBl0EOlCPUPkMnOhzJ4akwnJeNvHJS',
      ADMIN_CODE: '478'
    };

    const STAGES = [
      { id: 'new', label: 'New Idea', emoji: 'üí°', color: '#3B82F6' },
      { id: 'research', label: 'Research', emoji: 'üîç', color: '#8B5CF6' },
      { id: 'poc', label: 'Proof of Concept', emoji: 'üß™', color: '#F59E0B' },
      { id: 'codebase', label: 'Codebase Built', emoji: 'üíª', color: '#10B981' },
      { id: 'testing', label: 'Tested & Ready', emoji: '‚úÖ', color: '#84CC16' },
      { id: 'deployed', label: 'Deployed', emoji: 'üéâ', color: '#22C55E' },
    ];
  </script>

  <!-- ==================== APP CONTAINER ==================== -->
  <div id="app" class="min-h-screen flex flex-col">
    <!-- Loading State -->
    <div id="loading" class="min-h-screen flex items-center justify-center">
      <div class="text-center">
        <div class="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
        <p class="text-slate-400">Loading ideas...</p>
      </div>
    </div>

    <!-- Error State -->
    <div id="error" class="min-h-screen flex items-center justify-center p-4 hidden">
      <div class="text-center max-w-md">
        <div class="text-4xl mb-4">‚ö†Ô∏è</div>
        <h2 class="text-xl font-semibold text-white mb-2">Connection Error</h2>
        <p class="text-slate-400 mb-4">Unable to connect to the database. Please check your JSONBin configuration.</p>
        <p id="error-message" class="text-sm text-red-400 bg-red-500/10 rounded-lg p-3"></p>
      </div>
    </div>

    <!-- Main App (hidden until loaded) -->
    <div id="main-app" class="min-h-screen flex flex-col hidden">
      <!-- Header -->
      <header class="sticky top-0 z-40 bg-slate-900/95 backdrop-blur border-b border-slate-700">
        <div class="max-w-7xl mx-auto px-4 py-3">
          <div class="flex items-center justify-between gap-4">
            <!-- Logo -->
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center font-bold text-white text-sm">478</div>
              <div class="hidden sm:block">
                <h1 class="text-lg font-semibold text-white">Local 478</h1>
                <p class="text-xs text-slate-400">Ideas Pipeline</p>
              </div>
            </div>

            <!-- View Toggle -->
            <div class="flex items-center gap-1 bg-slate-800 rounded-lg p-1">
              <button onclick="setView('pipeline')" id="btn-pipeline" class="px-3 py-1.5 rounded-md text-sm font-medium transition-colors bg-blue-600 text-white">Pipeline</button>
              <button onclick="setView('category')" id="btn-category" class="px-3 py-1.5 rounded-md text-sm font-medium transition-colors text-slate-400 hover:text-white">Categories</button>
            </div>

            <!-- Actions -->
            <div class="flex items-center gap-2">
              <button onclick="refreshData()" class="p-2 text-slate-400 hover:text-white transition-colors" title="Refresh">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
              </button>
              <button onclick="openSubmitModal()" class="px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-lg transition-colors">+ Submit</button>
              <button onclick="toggleAdmin()" id="btn-admin" class="px-3 py-2 bg-slate-700 hover:bg-slate-600 text-slate-300 text-sm font-medium rounded-lg transition-colors">Admin</button>
            </div>
          </div>
        </div>
      </header>

      <!-- Main Content -->
      <main id="content" class="flex-1 flex flex-col"></main>
    </div>
  </div>

  <!-- ==================== MODALS ==================== -->

  <!-- Submit Modal -->
  <div id="submit-modal" class="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4 modal-backdrop hidden" onclick="closeSubmitModal()">
    <div class="bg-slate-800 rounded-xl w-full max-w-lg p-6 modal-content" onclick="event.stopPropagation()">
      <div id="submit-success" class="text-center py-8 hidden">
        <div class="text-5xl mb-4">üéâ</div>
        <h2 class="text-xl font-semibold text-white">Idea Submitted!</h2>
        <p class="text-slate-400 mt-2">Thanks for your contribution</p>
      </div>
      <div id="submit-form-container">
        <h2 class="text-xl font-semibold text-white mb-4">Submit New Idea</h2>
        <form id="submit-form" onsubmit="submitIdea(event)">
          <div class="mb-4">
            <label class="block text-sm font-medium text-slate-300 mb-2">Your Name <span class="text-red-400">*</span></label>
            <input type="text" id="input-submitter" required placeholder="Enter your name" class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium text-slate-300 mb-2">Idea Title <span class="text-red-400">*</span></label>
            <input type="text" id="input-title" required placeholder="What's your idea?" class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium text-slate-300 mb-2">Description (optional)</label>
            <textarea id="input-description" rows="3" placeholder="Describe your idea in more detail..." class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"></textarea>
          </div>
          <div class="mb-6">
            <label class="block text-sm font-medium text-slate-300 mb-2">Categories (optional)</label>
            <div id="category-select" class="flex flex-wrap gap-2"></div>
          </div>
          <div class="flex gap-3">
            <button type="button" onclick="closeSubmitModal()" class="flex-1 px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-colors">Cancel</button>
            <button type="submit" class="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">Submit Idea</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Admin Prompt Modal -->
  <div id="admin-modal" class="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4 modal-backdrop hidden" onclick="closeAdminModal()">
    <div class="bg-slate-800 rounded-xl w-full max-w-sm p-6 modal-content" onclick="event.stopPropagation()">
      <h2 class="text-xl font-semibold text-white mb-4">Admin Access</h2>
      <form onsubmit="loginAdmin(event)">
        <div class="mb-4">
          <label class="block text-sm font-medium text-slate-300 mb-2">Enter admin code</label>
          <input type="password" id="admin-code-input" placeholder="Enter code..." class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          <p id="admin-error" class="mt-2 text-sm text-red-400 hidden">Invalid admin code</p>
        </div>
        <div class="flex gap-3">
          <button type="button" onclick="closeAdminModal()" class="flex-1 px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-colors">Cancel</button>
          <button type="submit" class="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">Login</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Idea Detail Modal -->
  <div id="idea-modal" class="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4 modal-backdrop overflow-y-auto hidden" onclick="closeIdeaModal()">
    <div class="bg-slate-800 rounded-xl w-full max-w-2xl my-8 modal-content" onclick="event.stopPropagation()">
      <div id="idea-modal-content"></div>
    </div>
  </div>

  <!-- ==================== APPLICATION LOGIC ==================== -->
  <script>
    // State
    let state = {
      ideas: [],
      categories: [],
      view: 'pipeline',
      activeStage: 'new',
      isAdmin: localStorage.getItem('local478_admin') === 'true',
      selectedIdea: null,
      selectedCategories: [],
      selectedCategoryView: null
    };

    // ==================== API FUNCTIONS ====================
    async function fetchData() {
      const response = await fetch(`https://api.jsonbin.io/v3/b/${CONFIG.JSONBIN_BIN_ID}/latest`, {
        headers: { 'X-Access-Key': CONFIG.JSONBIN_API_KEY }
      });
      if (!response.ok) throw new Error(`Failed to fetch: ${response.status}`);
      const data = await response.json();
      return data.record;
    }

    async function saveData() {
      const response = await fetch(`https://api.jsonbin.io/v3/b/${CONFIG.JSONBIN_BIN_ID}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'X-Access-Key': CONFIG.JSONBIN_API_KEY
        },
        body: JSON.stringify({ ideas: state.ideas, categories: state.categories })
      });
      if (!response.ok) throw new Error(`Failed to save: ${response.status}`);
    }

    async function refreshData() {
      try {
        const data = await fetchData();
        state.ideas = data.ideas || [];
        state.categories = data.categories || [];
        render();
      } catch (err) {
        console.error('Refresh failed:', err);
        alert('Failed to refresh data. Please try again.');
      }
    }

    // ==================== INITIALIZATION ====================
    async function init() {
      try {
        const data = await fetchData();
        state.ideas = data.ideas || [];
        state.categories = data.categories || [];

        document.getElementById('loading').classList.add('hidden');
        document.getElementById('main-app').classList.remove('hidden');

        updateAdminButton();
        render();
      } catch (err) {
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('error').classList.remove('hidden');
        document.getElementById('error-message').textContent = err.message;
      }
    }

    // ==================== VIEW MANAGEMENT ====================
    function setView(view) {
      state.view = view;
      state.selectedCategoryView = null;
      document.getElementById('btn-pipeline').className = view === 'pipeline'
        ? 'px-3 py-1.5 rounded-md text-sm font-medium transition-colors bg-blue-600 text-white'
        : 'px-3 py-1.5 rounded-md text-sm font-medium transition-colors text-slate-400 hover:text-white';
      document.getElementById('btn-category').className = view === 'category'
        ? 'px-3 py-1.5 rounded-md text-sm font-medium transition-colors bg-blue-600 text-white'
        : 'px-3 py-1.5 rounded-md text-sm font-medium transition-colors text-slate-400 hover:text-white';
      render();
    }

    function setActiveStage(stageId) {
      state.activeStage = stageId;
      render();
    }

    // ==================== RENDER FUNCTIONS ====================
    function render() {
      const content = document.getElementById('content');
      if (state.view === 'pipeline') {
        content.innerHTML = renderPipelineView();
      } else {
        content.innerHTML = state.selectedCategoryView ? renderCategoryDetail() : renderCategoryView();
      }
    }

    function renderPipelineView() {
      const stageIdeas = state.ideas.filter(i => i.stage === state.activeStage);
      const activeIndex = STAGES.findIndex(s => s.id === state.activeStage);

      return `
        <div class="sticky top-0 z-30 bg-slate-900 border-b border-slate-700">
          <div class="max-w-7xl mx-auto px-4">
            <div class="flex items-center gap-2 overflow-x-auto py-3 scrollbar-hide">
              ${STAGES.map(stage => {
                const count = state.ideas.filter(i => i.stage === stage.id).length;
                const blocked = state.ideas.filter(i => i.stage === stage.id && i.blocked).length;
                const isActive = state.activeStage === stage.id;
                return `
                  <button onclick="setActiveStage('${stage.id}')" class="flex items-center gap-2 px-4 py-2 rounded-lg whitespace-nowrap transition-all ${isActive ? 'text-white' : 'text-slate-400 hover:text-white hover:bg-slate-800'}" style="${isActive ? `background-color: ${stage.color}30; color: ${stage.color}` : ''}">
                    <span>${stage.emoji}</span>
                    <span class="font-medium">${stage.label}</span>
                    <span class="px-2 py-0.5 rounded-full text-xs ${isActive ? 'bg-white/20' : 'bg-slate-700'}">${count}</span>
                    ${blocked > 0 ? `<span class="text-red-400 text-sm">üö©${blocked}</span>` : ''}
                  </button>
                `;
              }).join('')}
            </div>
          </div>
        </div>
        <div class="hidden md:flex items-center justify-between px-4 py-2 max-w-7xl mx-auto w-full">
          <button onclick="navigateStage(-1)" ${activeIndex === 0 ? 'disabled' : ''} class="flex items-center gap-2 px-3 py-1.5 rounded-lg text-sm text-slate-400 hover:text-white hover:bg-slate-800 disabled:opacity-30 disabled:cursor-not-allowed transition-colors">
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
            ${activeIndex > 0 ? STAGES[activeIndex - 1].label : ''}
          </button>
          <button onclick="navigateStage(1)" ${activeIndex === STAGES.length - 1 ? 'disabled' : ''} class="flex items-center gap-2 px-3 py-1.5 rounded-lg text-sm text-slate-400 hover:text-white hover:bg-slate-800 disabled:opacity-30 disabled:cursor-not-allowed transition-colors">
            ${activeIndex < STAGES.length - 1 ? STAGES[activeIndex + 1].label : ''}
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
          </button>
        </div>
        <div class="flex-1 overflow-y-auto px-4 py-4">
          <div class="max-w-7xl mx-auto">
            ${stageIdeas.length === 0 ? `
              <div class="text-center py-12">
                <div class="text-4xl mb-4">${STAGES[activeIndex].emoji}</div>
                <p class="text-slate-400">No ideas in this stage yet</p>
                <p class="text-slate-500 text-sm mt-1">${state.activeStage === 'new' ? 'Submit a new idea to get started!' : 'Move ideas from previous stages'}</p>
              </div>
            ` : `
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                ${stageIdeas.sort((a, b) => {
                  if (a.blocked !== b.blocked) return b.blocked - a.blocked;
                  return (b.createdAt || 0) - (a.createdAt || 0);
                }).map(idea => renderIdeaCard(idea)).join('')}
              </div>
            `}
          </div>
        </div>
        <div class="md:hidden text-center py-2 text-xs text-slate-500">Swipe left or right to navigate stages</div>
      `;
    }

    function renderCategoryView() {
      return `
        <div class="flex-1 overflow-y-auto px-4 py-6">
          <div class="max-w-7xl mx-auto">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              ${state.categories.map(cat => {
                const catIdeas = state.ideas.filter(i => (i.categories || []).includes(cat.id));
                const blocked = catIdeas.filter(i => i.blocked).length;
                const stageBreakdown = STAGES.map(s => ({ ...s, count: catIdeas.filter(i => i.stage === s.id).length }));
                const maxCount = Math.max(...stageBreakdown.map(s => s.count), 1);
                return `
                  <div onclick="openCategoryDetail('${cat.id}')" class="bg-slate-800 rounded-xl p-5 cursor-pointer hover:bg-slate-750 transition-all border-2 border-transparent hover:border-slate-600">
                    <div class="flex items-start justify-between mb-4">
                      <h3 class="text-lg font-semibold" style="color: ${cat.color}">${cat.label}</h3>
                      <div class="flex items-center gap-2">
                        ${blocked > 0 ? `<span class="text-red-400 text-sm">üö©${blocked}</span>` : ''}
                        <span class="px-2 py-1 bg-slate-700 rounded-lg text-sm text-slate-300">${catIdeas.length}</span>
                      </div>
                    </div>
                    <div class="space-y-1.5">
                      ${stageBreakdown.map(stage => `
                        <div class="flex items-center gap-2">
                          <span class="text-xs w-6">${stage.emoji}</span>
                          <div class="flex-1 h-2 bg-slate-700 rounded-full overflow-hidden">
                            <div class="h-full rounded-full transition-all" style="width: ${(stage.count / maxCount) * 100}%; background-color: ${stage.color}; min-width: ${stage.count > 0 ? '8px' : '0'}"></div>
                          </div>
                          <span class="text-xs text-slate-500 w-4 text-right">${stage.count}</span>
                        </div>
                      `).join('')}
                    </div>
                  </div>
                `;
              }).join('')}
              ${state.isAdmin ? `
                <div onclick="openAddCategoryModal()" class="bg-slate-800/50 rounded-xl p-5 cursor-pointer hover:bg-slate-800 transition-all border-2 border-dashed border-slate-600 hover:border-slate-500 flex items-center justify-center min-h-[200px]">
                  <div class="text-center">
                    <div class="text-3xl mb-2">+</div>
                    <p class="text-slate-400">Add Category</p>
                  </div>
                </div>
              ` : ''}
            </div>
          </div>
        </div>
      `;
    }

    function renderCategoryDetail() {
      const category = state.categories.find(c => c.id === state.selectedCategoryView);
      if (!category) return '';
      const categoryIdeas = state.ideas.filter(i => (i.categories || []).includes(category.id));

      return `
        <div class="flex flex-col h-full">
          <div class="sticky top-0 z-30 bg-slate-900 border-b border-slate-700">
            <div class="max-w-7xl mx-auto px-4 py-4">
              <button onclick="state.selectedCategoryView = null; render()" class="flex items-center gap-2 text-slate-400 hover:text-white mb-3 transition-colors">
                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                Back to Categories
              </button>
              <div class="flex items-center gap-3">
                <span class="px-4 py-2 rounded-lg text-lg font-medium" style="background-color: ${category.color}30; color: ${category.color}">${category.label}</span>
                <span class="text-slate-400">${categoryIdeas.length} idea${categoryIdeas.length !== 1 ? 's' : ''}</span>
              </div>
            </div>
          </div>
          <div class="flex-1 overflow-y-auto px-4 py-4">
            <div class="max-w-7xl mx-auto">
              ${categoryIdeas.length === 0 ? `
                <div class="text-center py-12"><p class="text-slate-400">No ideas in this category</p></div>
              ` : `
                <div class="space-y-3">
                  ${categoryIdeas.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0)).map(idea => {
                    const stage = STAGES.find(s => s.id === idea.stage);
                    return `
                      <div onclick="openIdeaModal('${idea.id}')" class="bg-slate-800 rounded-lg p-4 cursor-pointer hover:bg-slate-750 transition-all flex items-center gap-4">
                        <div class="w-2 h-12 rounded-full flex-shrink-0" style="background-color: ${stage?.color}"></div>
                        <div class="flex-1 min-w-0">
                          <div class="flex items-center gap-2 mb-1">
                            <h3 class="font-medium text-white truncate">${escapeHtml(idea.title)}</h3>
                            ${idea.blocked ? '<span class="text-red-400">üö©</span>' : ''}
                          </div>
                          <div class="flex items-center gap-3 text-sm">
                            <span class="px-2 py-0.5 rounded text-xs" style="background-color: ${stage?.color}20; color: ${stage?.color}">${stage?.emoji} ${stage?.label}</span>
                            <span class="text-slate-500">by ${escapeHtml(idea.submitter)}</span>
                          </div>
                        </div>
                      </div>
                    `;
                  }).join('')}
                </div>
              `}
            </div>
          </div>
        </div>
      `;
    }

    function renderIdeaCard(idea) {
      const stage = STAGES.find(s => s.id === idea.stage) || STAGES[0];
      const ideaCategories = (idea.categories || []).map(catId => state.categories.find(c => c.id === catId)).filter(Boolean);
      const displayCategories = ideaCategories.slice(0, 2);
      const remainingCount = ideaCategories.length - 2;
      const noteCount = (idea.notes || []).length;

      return `
        <div onclick="openIdeaModal('${idea.id}')" class="bg-slate-800 rounded-lg p-4 cursor-pointer hover:bg-slate-750 transition-all border-l-4 ${idea.blocked ? 'blocked-glow' : ''}" style="border-left-color: ${stage.color}">
          <div class="flex items-start justify-between gap-2 mb-2">
            <h3 class="font-medium text-white line-clamp-2">${escapeHtml(idea.title)}</h3>
            <div class="flex items-center gap-1 flex-shrink-0">
              ${idea.blocked ? '<span class="text-red-400" title="Blocked">üö©</span>' : ''}
              ${noteCount > 0 ? `<span class="text-slate-400 text-sm" title="${noteCount} notes">üìù ${noteCount}</span>` : ''}
            </div>
          </div>
          ${idea.description ? `<p class="text-slate-400 text-sm line-clamp-2 mb-3">${escapeHtml(idea.description)}</p>` : ''}
          ${ideaCategories.length > 0 ? `
            <div class="flex flex-wrap gap-1.5 mb-3">
              ${displayCategories.map(cat => `<span class="px-2 py-0.5 rounded-full text-xs font-medium" style="background-color: ${cat.color}20; color: ${cat.color}">${cat.label}</span>`).join('')}
              ${remainingCount > 0 ? `<span class="px-2 py-0.5 rounded-full text-xs font-medium bg-slate-700 text-slate-400">+${remainingCount}</span>` : ''}
            </div>
          ` : ''}
          <div class="flex items-center justify-between text-xs text-slate-500">
            <span>by ${escapeHtml(idea.submitter)}</span>
            ${idea.createdAt ? `<span>${new Date(idea.createdAt).toLocaleDateString()}</span>` : ''}
          </div>
        </div>
      `;
    }

    // ==================== MODAL FUNCTIONS ====================
    function openSubmitModal() {
      state.selectedCategories = [];
      document.getElementById('submit-form').reset();
      document.getElementById('submit-success').classList.add('hidden');
      document.getElementById('submit-form-container').classList.remove('hidden');
      renderCategorySelect();
      document.getElementById('submit-modal').classList.remove('hidden');
    }

    function closeSubmitModal() {
      document.getElementById('submit-modal').classList.add('hidden');
    }

    function renderCategorySelect() {
      const container = document.getElementById('category-select');
      container.innerHTML = state.categories.map(cat => `
        <button type="button" onclick="toggleCategorySelect('${cat.id}')" class="px-3 py-1.5 rounded-full text-sm font-medium transition-all ${state.selectedCategories.includes(cat.id) ? 'ring-2 ring-offset-2 ring-offset-slate-800' : 'opacity-60 hover:opacity-100'}" style="background-color: ${cat.color}30; color: ${cat.color}; ${state.selectedCategories.includes(cat.id) ? `ring-color: ${cat.color}` : ''}">${cat.label}</button>
      `).join('');
    }

    function toggleCategorySelect(catId) {
      if (state.selectedCategories.includes(catId)) {
        state.selectedCategories = state.selectedCategories.filter(id => id !== catId);
      } else {
        state.selectedCategories.push(catId);
      }
      renderCategorySelect();
    }

    async function submitIdea(e) {
      e.preventDefault();
      const submitter = document.getElementById('input-submitter').value.trim();
      const title = document.getElementById('input-title').value.trim();
      const description = document.getElementById('input-description').value.trim();

      if (!submitter || !title) return;

      const newIdea = {
        id: generateId(),
        title,
        description,
        submitter,
        stage: 'new',
        categories: [...state.selectedCategories],
        blocked: false,
        blockedReason: '',
        notes: [],
        createdAt: Date.now(),
        updatedAt: Date.now()
      };

      state.ideas.push(newIdea);

      try {
        await saveData();
        document.getElementById('submit-form-container').classList.add('hidden');
        document.getElementById('submit-success').classList.remove('hidden');
        setTimeout(() => {
          closeSubmitModal();
          render();
        }, 1500);
      } catch (err) {
        state.ideas.pop();
        alert('Failed to submit idea. Please try again.');
      }
    }

    function openIdeaModal(ideaId) {
      state.selectedIdea = state.ideas.find(i => i.id === ideaId);
      if (!state.selectedIdea) return;
      renderIdeaModal();
      document.getElementById('idea-modal').classList.remove('hidden');
    }

    function closeIdeaModal() {
      document.getElementById('idea-modal').classList.add('hidden');
      state.selectedIdea = null;
    }

    function renderIdeaModal() {
      const idea = state.selectedIdea;
      if (!idea) return;

      const stage = STAGES.find(s => s.id === idea.stage) || STAGES[0];
      const ideaCategories = (idea.categories || []).map(catId => state.categories.find(c => c.id === catId)).filter(Boolean);
      const availableCategories = state.categories.filter(c => !(idea.categories || []).includes(c.id));

      document.getElementById('idea-modal-content').innerHTML = `
        <div class="p-6 border-b border-slate-700">
          <div class="flex items-start justify-between gap-4">
            <div class="flex-1">
              <h2 class="text-xl font-semibold text-white mb-2">${escapeHtml(idea.title)}</h2>
              <div class="flex items-center gap-3 flex-wrap">
                <span class="px-3 py-1 rounded-full text-sm font-medium" style="background-color: ${stage.color}20; color: ${stage.color}">${stage.emoji} ${stage.label}</span>
                ${idea.blocked ? '<span class="px-3 py-1 rounded-full text-sm font-medium bg-red-500/20 text-red-400">üö© Blocked</span>' : ''}
              </div>
            </div>
            <button onclick="closeIdeaModal()" class="text-slate-400 hover:text-white p-1">
              <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
          </div>
        </div>
        <div class="p-6 space-y-6 max-h-[60vh] overflow-y-auto">
          ${idea.description ? `
            <div>
              <h3 class="text-sm font-medium text-slate-400 mb-2">Description</h3>
              <p class="text-slate-200 whitespace-pre-wrap">${escapeHtml(idea.description)}</p>
            </div>
          ` : ''}
          ${idea.blocked && idea.blockedReason ? `
            <div class="bg-red-500/10 border border-red-500/30 rounded-lg p-4">
              <h3 class="text-sm font-medium text-red-400 mb-1">Blocked Reason</h3>
              <p class="text-red-300">${escapeHtml(idea.blockedReason)}</p>
            </div>
          ` : ''}
          <div>
            <h3 class="text-sm font-medium text-slate-400 mb-2">Categories</h3>
            <div class="flex flex-wrap gap-2">
              ${ideaCategories.length > 0 ? ideaCategories.map(cat => `
                <span class="px-3 py-1 rounded-full text-sm font-medium inline-flex items-center gap-2" style="background-color: ${cat.color}20; color: ${cat.color}">
                  ${cat.label}
                  ${state.isAdmin ? `<button onclick="removeIdeaCategory('${idea.id}', '${cat.id}')" class="hover:opacity-70">√ó</button>` : ''}
                </span>
              `).join('') : '<span class="text-slate-500 text-sm">No categories</span>'}
            </div>
            ${state.isAdmin && availableCategories.length > 0 ? `
              <div class="mt-3">
                <p class="text-xs text-slate-500 mb-2">Add category:</p>
                <div class="flex flex-wrap gap-2">
                  ${availableCategories.map(cat => `
                    <button onclick="addIdeaCategory('${idea.id}', '${cat.id}')" class="px-2 py-1 rounded-full text-xs font-medium opacity-50 hover:opacity-100 transition-opacity" style="background-color: ${cat.color}20; color: ${cat.color}">+ ${cat.label}</button>
                  `).join('')}
                </div>
              </div>
            ` : ''}
          </div>
          <div class="flex items-center gap-6 text-sm text-slate-400">
            <span>Submitted by: <span class="text-white">${escapeHtml(idea.submitter)}</span></span>
            ${idea.createdAt ? `<span>${new Date(idea.createdAt).toLocaleDateString()}</span>` : ''}
          </div>
          <div>
            <h3 class="text-sm font-medium text-slate-400 mb-3">Notes (${(idea.notes || []).length})</h3>
            <div class="space-y-3">
              ${(idea.notes || []).map(note => `
                <div class="bg-slate-700/50 rounded-lg p-3">
                  <div class="flex items-start justify-between gap-2">
                    <p class="text-slate-200 text-sm">${escapeHtml(note.text)}</p>
                    ${state.isAdmin ? `<button onclick="deleteNote('${idea.id}', '${note.id}')" class="text-slate-500 hover:text-red-400 text-sm flex-shrink-0">Delete</button>` : ''}
                  </div>
                  <div class="flex items-center gap-3 mt-2 text-xs text-slate-500">
                    <span>${escapeHtml(note.author)}</span>
                    <span>${new Date(note.date).toLocaleDateString()}</span>
                  </div>
                </div>
              `).join('')}
            </div>
            ${state.isAdmin ? `
              <div class="mt-4 space-y-2">
                <input type="text" id="note-author" placeholder="Your name" class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                <div class="flex gap-2">
                  <input type="text" id="note-text" placeholder="Add a note..." class="flex-1 px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" onkeydown="if(event.key==='Enter')addNote('${idea.id}')">
                  <button onclick="addNote('${idea.id}')" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm rounded-lg transition-colors">Add</button>
                </div>
              </div>
            ` : ''}
          </div>
        </div>
        ${state.isAdmin ? `
          <div class="p-6 border-t border-slate-700 space-y-4">
            <div>
              <h3 class="text-sm font-medium text-slate-400 mb-2">Move to Stage</h3>
              <div class="flex flex-wrap gap-2">
                ${STAGES.map(s => `
                  <button onclick="moveIdea('${idea.id}', '${s.id}')" ${s.id === idea.stage ? 'disabled' : ''} class="px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${s.id === idea.stage ? 'bg-slate-600 text-slate-400 cursor-not-allowed' : 'hover:opacity-80'}" style="${s.id !== idea.stage ? `background-color: ${s.color}30; color: ${s.color}` : ''}">${s.emoji} ${s.label}</button>
                `).join('')}
              </div>
            </div>
            <div>
              <h3 class="text-sm font-medium text-slate-400 mb-2">Status</h3>
              <div id="blocked-controls">
                ${idea.blocked ? `
                  <button onclick="unblockIdea('${idea.id}')" class="px-4 py-2 rounded-lg text-sm font-medium transition-colors bg-green-600/20 hover:bg-green-600/30 text-green-400">‚úì Unblock Idea</button>
                ` : `
                  <div id="block-form-${idea.id}" class="hidden flex gap-2">
                    <input type="text" id="block-reason-${idea.id}" placeholder="Reason for blocking..." class="flex-1 px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 text-sm focus:outline-none focus:ring-2 focus:ring-red-500">
                    <button onclick="confirmBlockIdea('${idea.id}')" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white text-sm rounded-lg transition-colors">Block</button>
                    <button onclick="cancelBlockIdea('${idea.id}')" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white text-sm rounded-lg transition-colors">Cancel</button>
                  </div>
                  <button id="block-btn-${idea.id}" onclick="showBlockForm('${idea.id}')" class="px-4 py-2 rounded-lg text-sm font-medium transition-colors bg-red-600/20 hover:bg-red-600/30 text-red-400">üö© Flag as Blocked</button>
                `}
              </div>
            </div>
            <div>
              <button onclick="deleteIdea('${idea.id}')" id="delete-btn-${idea.id}" class="px-4 py-2 rounded-lg text-sm font-medium transition-colors bg-slate-700 hover:bg-slate-600 text-red-400">Delete Idea</button>
            </div>
          </div>
        ` : ''}
      `;
    }

    function openAdminModal() {
      document.getElementById('admin-code-input').value = '';
      document.getElementById('admin-error').classList.add('hidden');
      document.getElementById('admin-modal').classList.remove('hidden');
    }

    function closeAdminModal() {
      document.getElementById('admin-modal').classList.add('hidden');
    }

    function toggleAdmin() {
      if (state.isAdmin) {
        state.isAdmin = false;
        localStorage.removeItem('local478_admin');
        updateAdminButton();
        render();
      } else {
        openAdminModal();
      }
    }

    function loginAdmin(e) {
      e.preventDefault();
      const code = document.getElementById('admin-code-input').value;
      if (code === CONFIG.ADMIN_CODE) {
        state.isAdmin = true;
        localStorage.setItem('local478_admin', 'true');
        closeAdminModal();
        updateAdminButton();
        render();
      } else {
        document.getElementById('admin-error').classList.remove('hidden');
      }
    }

    function updateAdminButton() {
      const btn = document.getElementById('btn-admin');
      if (state.isAdmin) {
        btn.textContent = 'Exit Admin';
        btn.className = 'px-3 py-2 bg-red-600/20 hover:bg-red-600/30 text-red-400 text-sm font-medium rounded-lg transition-colors border border-red-600/30';
      } else {
        btn.textContent = 'Admin';
        btn.className = 'px-3 py-2 bg-slate-700 hover:bg-slate-600 text-slate-300 text-sm font-medium rounded-lg transition-colors';
      }
    }

    function openCategoryDetail(catId) {
      state.selectedCategoryView = catId;
      render();
    }

    function openAddCategoryModal() {
      const label = prompt('Enter category label (e.g., "üìä Analytics"):');
      if (!label || !label.trim()) return;
      const colors = ['#EC4899', '#8B5CF6', '#10B981', '#F59E0B', '#6366F1', '#06B6D4', '#EF4444'];
      const color = colors[Math.floor(Math.random() * colors.length)];
      addCategory(label.trim(), color);
    }

    // ==================== DATA OPERATIONS ====================
    async function moveIdea(ideaId, newStage) {
      const idea = state.ideas.find(i => i.id === ideaId);
      if (!idea) return;
      const oldStage = idea.stage;
      idea.stage = newStage;
      idea.updatedAt = Date.now();
      try {
        await saveData();
        renderIdeaModal();
        render();
      } catch (err) {
        idea.stage = oldStage;
        alert('Failed to move idea. Please try again.');
      }
    }

    function showBlockForm(ideaId) {
      document.getElementById(`block-btn-${ideaId}`).classList.add('hidden');
      document.getElementById(`block-form-${ideaId}`).classList.remove('hidden');
      document.getElementById(`block-reason-${ideaId}`).focus();
    }

    function cancelBlockIdea(ideaId) {
      document.getElementById(`block-btn-${ideaId}`).classList.remove('hidden');
      document.getElementById(`block-form-${ideaId}`).classList.add('hidden');
    }

    async function confirmBlockIdea(ideaId) {
      const reason = document.getElementById(`block-reason-${ideaId}`).value.trim();
      const idea = state.ideas.find(i => i.id === ideaId);
      if (!idea) return;
      idea.blocked = true;
      idea.blockedReason = reason;
      idea.updatedAt = Date.now();
      try {
        await saveData();
        state.selectedIdea = idea;
        renderIdeaModal();
        render();
      } catch (err) {
        idea.blocked = false;
        idea.blockedReason = '';
        alert('Failed to block idea. Please try again.');
      }
    }

    async function unblockIdea(ideaId) {
      const idea = state.ideas.find(i => i.id === ideaId);
      if (!idea) return;
      idea.blocked = false;
      idea.blockedReason = '';
      idea.updatedAt = Date.now();
      try {
        await saveData();
        state.selectedIdea = idea;
        renderIdeaModal();
        render();
      } catch (err) {
        idea.blocked = true;
        alert('Failed to unblock idea. Please try again.');
      }
    }

    async function addNote(ideaId) {
      const author = document.getElementById('note-author').value.trim();
      const text = document.getElementById('note-text').value.trim();
      if (!author || !text) return;

      const idea = state.ideas.find(i => i.id === ideaId);
      if (!idea) return;

      const note = { id: generateId(), text, author, date: Date.now() };
      idea.notes = idea.notes || [];
      idea.notes.push(note);
      idea.updatedAt = Date.now();

      try {
        await saveData();
        document.getElementById('note-author').value = '';
        document.getElementById('note-text').value = '';
        state.selectedIdea = idea;
        renderIdeaModal();
      } catch (err) {
        idea.notes.pop();
        alert('Failed to add note. Please try again.');
      }
    }

    async function deleteNote(ideaId, noteId) {
      const idea = state.ideas.find(i => i.id === ideaId);
      if (!idea) return;

      const noteIndex = (idea.notes || []).findIndex(n => n.id === noteId);
      if (noteIndex === -1) return;

      const deletedNote = idea.notes.splice(noteIndex, 1)[0];
      idea.updatedAt = Date.now();

      try {
        await saveData();
        state.selectedIdea = idea;
        renderIdeaModal();
      } catch (err) {
        idea.notes.splice(noteIndex, 0, deletedNote);
        alert('Failed to delete note. Please try again.');
      }
    }

    async function addIdeaCategory(ideaId, catId) {
      const idea = state.ideas.find(i => i.id === ideaId);
      if (!idea) return;
      idea.categories = idea.categories || [];
      idea.categories.push(catId);
      idea.updatedAt = Date.now();
      try {
        await saveData();
        state.selectedIdea = idea;
        renderIdeaModal();
        render();
      } catch (err) {
        idea.categories.pop();
        alert('Failed to add category. Please try again.');
      }
    }

    async function removeIdeaCategory(ideaId, catId) {
      const idea = state.ideas.find(i => i.id === ideaId);
      if (!idea) return;
      const index = (idea.categories || []).indexOf(catId);
      if (index === -1) return;
      idea.categories.splice(index, 1);
      idea.updatedAt = Date.now();
      try {
        await saveData();
        state.selectedIdea = idea;
        renderIdeaModal();
        render();
      } catch (err) {
        idea.categories.splice(index, 0, catId);
        alert('Failed to remove category. Please try again.');
      }
    }

    async function deleteIdea(ideaId) {
      const btn = document.getElementById(`delete-btn-${ideaId}`);
      if (btn.dataset.confirm !== 'true') {
        btn.dataset.confirm = 'true';
        btn.textContent = 'Click again to confirm';
        btn.className = 'px-4 py-2 rounded-lg text-sm font-medium transition-colors bg-red-600 hover:bg-red-700 text-white';
        return;
      }

      const index = state.ideas.findIndex(i => i.id === ideaId);
      if (index === -1) return;
      const deleted = state.ideas.splice(index, 1)[0];

      try {
        await saveData();
        closeIdeaModal();
        render();
      } catch (err) {
        state.ideas.splice(index, 0, deleted);
        alert('Failed to delete idea. Please try again.');
      }
    }

    async function addCategory(label, color) {
      const newCat = { id: generateId(), label, color };
      state.categories.push(newCat);
      try {
        await saveData();
        render();
      } catch (err) {
        state.categories.pop();
        alert('Failed to add category. Please try again.');
      }
    }

    function navigateStage(direction) {
      const currentIndex = STAGES.findIndex(s => s.id === state.activeStage);
      const newIndex = currentIndex + direction;
      if (newIndex >= 0 && newIndex < STAGES.length) {
        state.activeStage = STAGES[newIndex].id;
        render();
      }
    }

    // ==================== UTILITIES ====================
    function generateId() {
      return Math.random().toString(36).substr(2, 9) + Date.now().toString(36);
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Touch swipe support
    let touchStartX = null;
    document.addEventListener('touchstart', e => { touchStartX = e.touches[0].clientX; });
    document.addEventListener('touchend', e => {
      if (touchStartX === null || state.view !== 'pipeline') return;
      const diff = touchStartX - e.changedTouches[0].clientX;
      if (Math.abs(diff) > 50) navigateStage(diff > 0 ? 1 : -1);
      touchStartX = null;
    });

    // Initialize
    init();
  </script>
</body>
</html>
