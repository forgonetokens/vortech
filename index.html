<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>VORTECH // Mission Control</title>
  <meta name="description" content="VORTECH - Mission-critical ideation system. 100 ideas. One system.">
  <meta name="theme-color" content="#0A1628">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="VORTECH">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="format-detection" content="telephone=no">
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <link rel="manifest" href="manifest.json">
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            vortech: {
              bg: '#0A1628',
              surface: '#0F1D32',
              panel: '#132238',
              border: '#1E3A5F',
              cyan: '#00D9FF',
              amber: '#FF6B35',
              green: '#00FF9F',
              dim: '#4A6B8A',
            }
          },
          fontFamily: {
            mono: ['JetBrains Mono', 'monospace'],
          }
        }
      }
    }
  </script>
  <style>
    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
    }
    html {
      height: 100%;
      overflow: hidden;
    }
    body {
      height: 100%;
      overflow: hidden;
      background-color: #0A1628;
      color: #E0F4FF;
      font-family: 'JetBrains Mono', monospace;
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);
    }
    #app {
      height: 100%;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative;
    }

    /* Scanline overlay */
    #app::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: repeating-linear-gradient(
        0deg,
        transparent,
        transparent 2px,
        rgba(0, 217, 255, 0.03) 2px,
        rgba(0, 217, 255, 0.03) 4px
      );
      pointer-events: none;
      z-index: 9999;
    }

    /* Prevent iOS rubber-banding on main scroll areas */
    .scroll-container {
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
    }

    /* Custom scrollbar - HUD style */
    ::-webkit-scrollbar { width: 4px; height: 4px; }
    ::-webkit-scrollbar-track { background: #0A1628; }
    ::-webkit-scrollbar-thumb { background: #00D9FF40; border-radius: 2px; }
    ::-webkit-scrollbar-thumb:hover { background: #00D9FF80; }

    /* Animations */
    .modal-backdrop { animation: fadeIn 150ms ease-out; }
    .modal-content { animation: slideUp 200ms ease-out; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideUp { from { opacity: 0; transform: translateY(20px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
    @keyframes successPulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    @keyframes glowPulse { 0%, 100% { box-shadow: 0 0 5px #00D9FF40, inset 0 0 5px #00D9FF10; } 50% { box-shadow: 0 0 15px #00D9FF60, inset 0 0 10px #00D9FF20; } }
    @keyframes scanIn { from { clip-path: inset(0 100% 0 0); } to { clip-path: inset(0 0 0 0); } }
    @keyframes statusBlink { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .success-pulse { animation: successPulse 300ms ease-out; }
    .stalled-glow { box-shadow: 0 0 0 1px #FF6B35, 0 0 20px rgba(255, 107, 53, 0.3); }
    .glow-pulse { animation: glowPulse 2s ease-in-out infinite; }
    .scan-in { animation: scanIn 0.3s ease-out; }
    .status-blink { animation: statusBlink 2s ease-in-out infinite; }

    /* HUD corner brackets */
    .hud-bracket {
      position: relative;
    }
    .hud-bracket::before,
    .hud-bracket::after {
      content: '';
      position: absolute;
      width: 12px;
      height: 12px;
      border-color: #00D9FF40;
      border-style: solid;
    }
    .hud-bracket::before {
      top: -1px;
      left: -1px;
      border-width: 2px 0 0 2px;
    }
    .hud-bracket::after {
      bottom: -1px;
      right: -1px;
      border-width: 0 2px 2px 0;
    }
    .hud-bracket-amber::before,
    .hud-bracket-amber::after {
      border-color: #FF6B3540;
    }
    .hud-bracket-green::before,
    .hud-bracket-green::after {
      border-color: #00FF9F40;
    }

    /* Pull to refresh */
    .pull-indicator {
      transition: transform 0.2s ease-out;
    }
    .pulling .pull-indicator {
      transform: rotate(180deg);
    }

    /* Text utilities */
    .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    .text-glow { text-shadow: 0 0 10px currentColor; }
    .text-glow-cyan { text-shadow: 0 0 10px #00D9FF80; }
    .text-glow-amber { text-shadow: 0 0 10px #FF6B3580; }
    .text-glow-green { text-shadow: 0 0 10px #00FF9F80; }

    /* Touch-friendly inputs */
    input, textarea, button, select {
      font-size: 16px; /* Prevents iOS zoom */
      touch-action: manipulation;
      font-family: 'JetBrains Mono', monospace;
    }

    /* Active states for touch feedback */
    .touch-active:active {
      transform: scale(0.98);
      opacity: 0.9;
    }

    /* Modal full-screen on mobile */
    @media (max-width: 640px) {
      .modal-mobile-full {
        margin: 0 !important;
        border-radius: 0 !important;
        min-height: 100vh;
        max-height: 100vh;
      }
      .modal-mobile-full .modal-scroll {
        max-height: calc(100vh - 200px) !important;
      }
    }

    /* Safe area bottom padding for fixed elements */
    .safe-bottom {
      padding-bottom: max(0.5rem, env(safe-area-inset-bottom));
    }

    /* HUD card styling */
    .hud-card {
      background: linear-gradient(135deg, #0F1D32 0%, #132238 100%);
      border: 1px solid #1E3A5F;
      position: relative;
    }
    .hud-card:hover {
      border-color: #00D9FF60;
      box-shadow: 0 0 20px rgba(0, 217, 255, 0.1);
    }

    /* Stage indicator dots */
    .stage-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      box-shadow: 0 0 8px currentColor;
    }
  </style>
</head>
<body>
  <!-- ==================== CONFIGURATION ==================== -->
  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDZZR9jZ8nQuv6eppv7CGpWwcBxrO7bWUA",
      authDomain: "vortech-5da11.firebaseapp.com",
      projectId: "vortech-5da11",
      storageBucket: "vortech-5da11.firebasestorage.app",
      messagingSenderId: "398486101126",
      appId: "1:398486101126:web:20d8b8cb8886df51758507"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const googleProvider = new firebase.auth.GoogleAuthProvider();

    // Current user
    let currentUser = null;

    const CONFIG = {
      ADMIN_CODE: 'vortech',
      ALLOWED_EMAILS: ['connorjohnsullivan@gmail.com']
    };

    // Auth functions
    async function signInWithGoogle() {
      try {
        document.getElementById('login-screen').innerHTML = `
          <div class="text-center">
            <div class="w-16 h-16 border-2 border-[#00D9FF] border-t-transparent rounded-full animate-spin mx-auto mb-4" style="box-shadow: 0 0 20px #00D9FF40;"></div>
            <p class="text-[#00D9FF] font-mono text-sm tracking-widest uppercase">AUTHENTICATING...</p>
          </div>
        `;
        await auth.signInWithPopup(googleProvider);
      } catch (error) {
        console.error('Auth error:', error);
        location.reload();
      }
    }

    function signOut() {
      auth.signOut();
    }

    const STAGES = [
      { id: 'new', label: 'INBOX', emoji: 'üì•', color: '#00D9FF' },
      { id: 'research', label: 'RECON', emoji: 'üîç', color: '#8B5CF6' },
      { id: 'poc', label: 'PROTOTYPE', emoji: '‚ö°', color: '#FF6B35' },
      { id: 'codebase', label: 'BUILD', emoji: 'üîß', color: '#00D9FF' },
      { id: 'testing', label: 'TESTING', emoji: 'üéØ', color: '#FFD700' },
      { id: 'deployed', label: 'DEPLOYED', emoji: 'üöÄ', color: '#00FF9F' },
    ];
  </script>

  <!-- ==================== APP CONTAINER ==================== -->
  <div id="app">
    <!-- Login Screen -->
    <div id="login-screen" class="flex-1 flex items-center justify-center p-4">
      <div class="text-center max-w-md w-full">
        <div class="hud-bracket p-8 bg-[#0F1D32] rounded-lg border border-[#1E3A5F]">
          <!-- Logo -->
          <div class="w-20 h-20 bg-[#0A1628] border-2 border-[#00D9FF] rounded-lg flex items-center justify-center mx-auto mb-6 glow-pulse">
            <span class="text-[#00D9FF] font-bold text-2xl">VT</span>
          </div>
          <h1 class="text-2xl font-bold text-[#00D9FF] tracking-wider mb-2 text-glow-cyan">VORTECH</h1>
          <p class="text-[#4A6B8A] text-sm uppercase tracking-widest mb-8">Mission Control</p>

          <div class="space-y-4">
            <p class="text-[#4A6B8A] text-xs uppercase tracking-wider mb-4">AUTHENTICATION REQUIRED</p>
            <button onclick="signInWithGoogle()" class="w-full px-6 py-4 bg-[#0A1628] hover:bg-[#132238] text-[#E0F4FF] rounded border border-[#1E3A5F] hover:border-[#00D9FF]/50 transition-all flex items-center justify-center gap-3 touch-active">
              <svg class="w-5 h-5" viewBox="0 0 24 24">
                <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
              </svg>
              <span class="uppercase tracking-wider text-sm font-medium">Sign in with Google</span>
            </button>
          </div>

          <p class="text-[#4A6B8A]/50 text-xs mt-8 uppercase tracking-wider">100 IDEAS. ONE SYSTEM.</p>
        </div>
      </div>
    </div>

    <!-- Loading State -->
    <div id="loading" class="flex-1 flex items-center justify-center hidden">
      <div class="text-center">
        <div class="w-16 h-16 border-2 border-[#00D9FF] border-t-transparent rounded-full animate-spin mx-auto mb-4" style="box-shadow: 0 0 20px #00D9FF40;"></div>
        <p class="text-[#00D9FF] font-mono text-sm tracking-widest uppercase status-blink">INITIALIZING SYSTEMS...</p>
        <p class="text-[#4A6B8A] font-mono text-xs mt-2 tracking-wider">LOADING OBJECTIVES</p>
      </div>
    </div>

    <!-- Error State -->
    <div id="error" class="flex-1 flex items-center justify-center p-4 hidden">
      <div class="text-center max-w-md hud-bracket hud-bracket-amber p-8">
        <div class="text-5xl mb-4">‚ö†Ô∏è</div>
        <h2 class="text-xl font-semibold text-[#FF6B35] mb-2 uppercase tracking-wider">CONNECTION FAILURE</h2>
        <p class="text-[#4A6B8A] mb-4 text-sm">Unable to establish database link.</p>
        <p id="error-message" class="text-sm text-[#FF6B35] bg-[#FF6B35]/10 rounded-lg p-3 mb-4 font-mono border border-[#FF6B35]/30"></p>
        <button onclick="location.reload()" class="px-6 py-3 bg-[#FF6B35]/20 hover:bg-[#FF6B35]/30 text-[#FF6B35] rounded-lg touch-active border border-[#FF6B35]/50 uppercase tracking-wider text-sm">
          RETRY CONNECTION
        </button>
      </div>
    </div>

    <!-- Main App (hidden until loaded) -->
    <div id="main-app" class="flex-1 flex flex-col overflow-hidden hidden">
      <!-- Header -->
      <header class="flex-shrink-0 bg-[#0F1D32] border-b border-[#1E3A5F] z-40">
        <div class="px-3 py-2 sm:px-4 sm:py-3">
          <div class="flex items-center justify-between gap-2">
            <!-- Logo -->
            <div class="flex items-center gap-2 flex-shrink-0">
              <div class="w-9 h-9 sm:w-10 sm:h-10 bg-[#0A1628] border border-[#00D9FF] rounded flex items-center justify-center font-bold text-[#00D9FF] text-xs sm:text-sm glow-pulse">VT</div>
              <div class="hidden xs:block sm:block">
                <h1 class="text-sm sm:text-lg font-bold text-[#00D9FF] leading-tight tracking-wider text-glow-cyan">VORTECH</h1>
                <p class="text-[10px] sm:text-xs text-[#4A6B8A] leading-tight uppercase tracking-widest">Mission Control</p>
              </div>
            </div>

            <!-- View Toggle -->
            <div class="flex items-center bg-[#0A1628] rounded p-0.5 sm:p-1 border border-[#1E3A5F]">
              <button onclick="setView('pipeline')" id="btn-pipeline" class="px-2 py-1.5 sm:px-3 sm:py-1.5 rounded text-xs sm:text-sm font-medium transition-colors bg-[#00D9FF]/20 text-[#00D9FF] touch-active uppercase tracking-wider">Pipeline</button>
              <button onclick="setView('category')" id="btn-category" class="px-2 py-1.5 sm:px-3 sm:py-1.5 rounded text-xs sm:text-sm font-medium transition-colors text-[#4A6B8A] touch-active uppercase tracking-wider">Categories</button>
            </div>

            <!-- Actions -->
            <div class="flex items-center gap-1 sm:gap-2 flex-shrink-0">
              <button onclick="openBugReportModal()" class="p-2.5 sm:p-2 text-[#4A6B8A] hover:text-[#FF6B35] transition-colors rounded touch-active" title="Report Bug">
                üêõ
              </button>
              <button onclick="openBugListModal()" id="btn-bug-list" class="hidden p-2.5 sm:p-2 text-[#FF6B35] hover:text-[#FF8F6B] transition-colors rounded touch-active" title="View Bug Reports">
                üìã
              </button>
              <button onclick="signOut()" class="p-2.5 sm:p-2 text-[#4A6B8A] hover:text-[#FF6B35] transition-colors rounded touch-active" title="Sign Out">
                üö™
              </button>
              <button onclick="openSubmitModal()" class="px-3 py-2 sm:px-4 sm:py-2 bg-[#00D9FF]/20 hover:bg-[#00D9FF]/30 text-[#00D9FF] text-xs sm:text-sm font-semibold rounded transition-all touch-active border border-[#00D9FF]/50 uppercase tracking-wider">
                <span class="sm:hidden">+ NEW</span>
                <span class="hidden sm:inline">+ NEW OBJECTIVE</span>
              </button>
              <button onclick="toggleAdmin()" id="btn-admin" class="px-2.5 py-2 sm:px-3 sm:py-2 bg-[#132238] hover:bg-[#1E3A5F] text-[#4A6B8A] text-xs sm:text-sm font-medium rounded transition-colors touch-active border border-[#1E3A5F] uppercase tracking-wider">
                <span class="sm:hidden">‚öôÔ∏è</span>
                <span class="hidden sm:inline">ADMIN</span>
              </button>
            </div>
          </div>
        </div>
      </header>

      <!-- Status Bar -->
      <div class="bg-[#0A1628] border-b border-[#1E3A5F] px-3 py-2 sm:px-4 sm:py-2.5 flex-shrink-0">
        <div class="flex items-center justify-between text-xs sm:text-sm">
          <div class="flex items-center gap-3">
            <span class="flex items-center gap-1.5">
              <span class="w-2 h-2 bg-[#00FF9F] rounded-full status-blink" style="box-shadow: 0 0 8px #00FF9F;"></span>
              <span class="text-[#00FF9F] uppercase tracking-wider font-medium">SYSTEMS ONLINE</span>
            </span>
          </div>
          <div class="flex items-center gap-4 text-[#4A6B8A]">
            <span id="objective-counter" class="uppercase tracking-wider">TRACKING: <span class="text-[#00D9FF]">0</span>/100 OBJECTIVES</span>
          </div>
        </div>
      </div>

      <!-- Offline Banner -->
      <div id="offline-banner" class="hidden bg-[#FF6B35]/20 text-[#FF6B35] text-center py-2 px-4 text-sm font-medium flex-shrink-0 border-y border-[#FF6B35]/30 uppercase tracking-wider">
        <span>‚ö†Ô∏è CONNECTION LOST ‚Äî CHANGES WILL SYNC WHEN RESTORED</span>
      </div>

      <!-- Main Content -->
      <main id="content" class="flex-1 flex flex-col overflow-hidden"></main>
    </div>
  </div>

  <!-- ==================== MODALS ==================== -->

  <!-- Submit Modal -->
  <div id="submit-modal" class="fixed inset-0 bg-[#0A1628]/90 flex items-end sm:items-center justify-center z-50 modal-backdrop hidden" onclick="closeSubmitModal()">
    <div class="bg-[#0F1D32] rounded-t-lg sm:rounded-lg w-full sm:max-w-lg sm:m-4 modal-content modal-mobile-full border border-[#1E3A5F] hud-bracket" onclick="event.stopPropagation()">
      <div id="submit-success" class="text-center py-12 hidden">
        <div class="text-6xl mb-4">üöÄ</div>
        <h2 class="text-xl font-semibold text-[#00FF9F] uppercase tracking-wider text-glow-green">OBJECTIVE LOGGED</h2>
        <p class="text-[#4A6B8A] mt-2">Mission queued successfully</p>
      </div>
      <div id="submit-form-container">
        <!-- Drag handle for mobile -->
        <div class="sm:hidden flex justify-center pt-3 pb-1">
          <div class="w-10 h-1 bg-[#1E3A5F] rounded-full"></div>
        </div>
        <div class="p-4 sm:p-6">
          <h2 class="text-lg sm:text-xl font-semibold text-[#00D9FF] mb-4 uppercase tracking-wider">+ NEW OBJECTIVE</h2>
          <form id="submit-form" onsubmit="submitIdea(event)">
            <div class="mb-4">
              <label class="block text-xs font-medium text-[#4A6B8A] mb-2 uppercase tracking-wider">OPERATOR ID <span class="text-[#FF6B35]">*</span></label>
              <input type="text" id="input-submitter" required placeholder="Enter designation" autocomplete="name" class="w-full px-4 py-3 bg-[#0A1628] border border-[#1E3A5F] rounded text-[#E0F4FF] placeholder-[#4A6B8A] focus:outline-none focus:ring-1 focus:ring-[#00D9FF] focus:border-[#00D9FF]">
            </div>
            <div class="mb-4">
              <label class="block text-xs font-medium text-[#4A6B8A] mb-2 uppercase tracking-wider">OBJECTIVE TITLE <span class="text-[#FF6B35]">*</span></label>
              <input type="text" id="input-title" required placeholder="Mission designation" autocomplete="off" class="w-full px-4 py-3 bg-[#0A1628] border border-[#1E3A5F] rounded text-[#E0F4FF] placeholder-[#4A6B8A] focus:outline-none focus:ring-1 focus:ring-[#00D9FF] focus:border-[#00D9FF]">
            </div>
            <div class="mb-4">
              <label class="block text-xs font-medium text-[#4A6B8A] mb-2 uppercase tracking-wider">MISSION BRIEF <span class="text-[#4A6B8A]">(OPTIONAL)</span></label>
              <textarea id="input-description" rows="3" placeholder="Describe the objective..." class="w-full px-4 py-3 bg-[#0A1628] border border-[#1E3A5F] rounded text-[#E0F4FF] placeholder-[#4A6B8A] focus:outline-none focus:ring-1 focus:ring-[#00D9FF] focus:border-[#00D9FF] resize-none"></textarea>
            </div>
            <div class="mb-6">
              <label class="block text-xs font-medium text-[#4A6B8A] mb-2 uppercase tracking-wider">CATEGORY TAGS</label>
              <div id="category-select" class="flex flex-wrap gap-2"></div>
            </div>
            <div class="flex gap-3 safe-bottom">
              <button type="button" onclick="closeSubmitModal()" class="flex-1 px-4 py-3 bg-[#132238] hover:bg-[#1E3A5F] text-[#4A6B8A] rounded transition-colors touch-active font-medium uppercase tracking-wider text-sm border border-[#1E3A5F]">ABORT</button>
              <button type="submit" id="submit-btn" class="flex-1 px-4 py-3 bg-[#00D9FF]/20 hover:bg-[#00D9FF]/30 text-[#00D9FF] rounded transition-colors touch-active font-medium uppercase tracking-wider text-sm border border-[#00D9FF]/50">SUBMIT</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Admin Prompt Modal -->
  <div id="admin-modal" class="fixed inset-0 bg-[#0A1628]/90 flex items-end sm:items-center justify-center z-50 modal-backdrop hidden" onclick="closeAdminModal()">
    <div class="bg-[#0F1D32] rounded-t-lg sm:rounded-lg w-full sm:max-w-sm sm:m-4 modal-content border border-[#1E3A5F] hud-bracket" onclick="event.stopPropagation()">
      <!-- Drag handle for mobile -->
      <div class="sm:hidden flex justify-center pt-3 pb-1">
        <div class="w-10 h-1 bg-[#1E3A5F] rounded-full"></div>
      </div>
      <div class="p-4 sm:p-6">
        <h2 class="text-lg sm:text-xl font-semibold text-[#FF6B35] mb-4 uppercase tracking-wider">üîê ADMIN ACCESS</h2>
        <form onsubmit="loginAdmin(event)">
          <div class="mb-4">
            <label class="block text-xs font-medium text-[#4A6B8A] mb-2 uppercase tracking-wider">ENTER ACCESS CODE</label>
            <input type="password" id="admin-code-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full px-4 py-3 bg-[#0A1628] border border-[#1E3A5F] rounded text-[#E0F4FF] placeholder-[#4A6B8A] focus:outline-none focus:ring-1 focus:ring-[#FF6B35] focus:border-[#FF6B35] text-center text-xl tracking-widest">
            <p id="admin-error" class="mt-2 text-sm text-[#FF6B35] hidden uppercase tracking-wider">‚ö†Ô∏è ACCESS DENIED</p>
          </div>
          <div class="flex gap-3 safe-bottom">
            <button type="button" onclick="closeAdminModal()" class="flex-1 px-4 py-3 bg-[#132238] hover:bg-[#1E3A5F] text-[#4A6B8A] rounded transition-colors touch-active font-medium uppercase tracking-wider text-sm border border-[#1E3A5F]">CANCEL</button>
            <button type="submit" class="flex-1 px-4 py-3 bg-[#FF6B35]/20 hover:bg-[#FF6B35]/30 text-[#FF6B35] rounded transition-colors touch-active font-medium uppercase tracking-wider text-sm border border-[#FF6B35]/50">AUTHENTICATE</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Bug Report Modal -->
  <div id="bug-modal" class="fixed inset-0 bg-[#0A1628]/90 flex items-end sm:items-center justify-center z-50 modal-backdrop hidden" onclick="closeBugReportModal()">
    <div class="bg-[#0F1D32] rounded-t-lg sm:rounded-lg w-full sm:max-w-md sm:m-4 modal-content border border-[#1E3A5F] hud-bracket hud-bracket-amber" onclick="event.stopPropagation()">
      <!-- Drag handle for mobile -->
      <div class="sm:hidden flex justify-center pt-3 pb-1">
        <div class="w-10 h-1 bg-[#1E3A5F] rounded-full"></div>
      </div>
      <div class="p-4 sm:p-6">
        <h2 class="text-lg sm:text-xl font-semibold text-[#FF6B35] mb-2 uppercase tracking-wider">üêõ REPORT ANOMALY</h2>
        <p class="text-[#4A6B8A] text-sm mb-4">Detected a system malfunction? Log it here.</p>
        <form onsubmit="submitBugReport(event)">
          <div class="mb-4">
            <label class="block text-xs font-medium text-[#4A6B8A] mb-2 uppercase tracking-wider">ANOMALY DESCRIPTION</label>
            <textarea id="bug-description" rows="4" placeholder="Describe the malfunction..." class="w-full px-4 py-3 bg-[#0A1628] border border-[#1E3A5F] rounded text-[#E0F4FF] placeholder-[#4A6B8A] focus:outline-none focus:ring-1 focus:ring-[#FF6B35] focus:border-[#FF6B35] resize-none"></textarea>
          </div>
          <div class="mb-4">
            <label class="block text-xs font-medium text-[#4A6B8A] mb-2 uppercase tracking-wider">CONTACT CHANNEL <span class="text-[#4A6B8A]">(OPTIONAL)</span></label>
            <input type="text" id="bug-contact" placeholder="Email or designation for follow-up..." class="w-full px-4 py-3 bg-[#0A1628] border border-[#1E3A5F] rounded text-[#E0F4FF] placeholder-[#4A6B8A] focus:outline-none focus:ring-1 focus:ring-[#FF6B35] focus:border-[#FF6B35]">
          </div>
          <div class="flex gap-3 safe-bottom">
            <button type="button" onclick="closeBugReportModal()" class="flex-1 px-4 py-3 bg-[#132238] hover:bg-[#1E3A5F] text-[#4A6B8A] rounded transition-colors touch-active font-medium uppercase tracking-wider text-sm border border-[#1E3A5F]">CANCEL</button>
            <button type="submit" class="flex-1 px-4 py-3 bg-[#FF6B35]/20 hover:bg-[#FF6B35]/30 text-[#FF6B35] rounded transition-colors touch-active font-medium uppercase tracking-wider text-sm border border-[#FF6B35]/50">LOG ANOMALY</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Bug List Modal (Admin) -->
  <div id="bug-list-modal" class="fixed inset-0 bg-[#0A1628]/90 flex items-end sm:items-center justify-center z-50 modal-backdrop hidden" onclick="closeBugListModal()">
    <div class="bg-[#0F1D32] rounded-t-lg sm:rounded-lg w-full sm:max-w-2xl sm:m-4 modal-content modal-mobile-full max-h-[95vh] sm:max-h-[90vh] flex flex-col border border-[#1E3A5F] hud-bracket hud-bracket-amber" onclick="event.stopPropagation()">
      <!-- Drag handle for mobile -->
      <div class="sm:hidden flex justify-center pt-3 pb-1">
        <div class="w-10 h-1 bg-[#1E3A5F] rounded-full"></div>
      </div>
      <div class="p-4 sm:p-6 flex flex-col h-full">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg sm:text-xl font-semibold text-[#FF6B35] uppercase tracking-wider">üìã ANOMALY LOG</h2>
          <button onclick="closeBugListModal()" class="p-2 text-[#4A6B8A] hover:text-[#E0F4FF] transition-colors rounded">‚úï</button>
        </div>
        <div id="bug-list-content" class="flex-1 overflow-y-auto space-y-3 safe-bottom"></div>
      </div>
    </div>
  </div>

  <!-- Idea Detail Modal -->
  <div id="idea-modal" class="fixed inset-0 bg-[#0A1628]/90 flex items-end sm:items-center justify-center z-50 modal-backdrop hidden" onclick="closeIdeaModal()">
    <div class="bg-[#0F1D32] rounded-t-lg sm:rounded-lg w-full sm:max-w-2xl sm:m-4 modal-content modal-mobile-full max-h-[95vh] sm:max-h-[90vh] flex flex-col border border-[#1E3A5F] hud-bracket" onclick="event.stopPropagation()">
      <div id="idea-modal-content" class="flex-1 overflow-hidden flex flex-col"></div>
    </div>
  </div>

  <!-- ==================== APPLICATION LOGIC ==================== -->
  <script>
    // State
    let state = {
      ideas: [],
      categories: [],
      view: 'pipeline',
      activeStage: 'new',
      isAdmin: localStorage.getItem('vortech_admin') === 'true',
      selectedIdea: null,
      selectedCategories: [],
      selectedCategoryView: null,
      isRefreshing: false,
      isOffline: !navigator.onLine,
      isEditingIdea: false
    };

    // ==================== FIREBASE FUNCTIONS ====================
    const ideasRef = db.collection('ideas');
    const categoriesRef = db.collection('categories');

    // Real-time listener for ideas
    function subscribeToIdeas() {
      return ideasRef.onSnapshot(snapshot => {
        state.ideas = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        render();
        // Update selected idea if it's open
        if (state.selectedIdea) {
          state.selectedIdea = state.ideas.find(i => i.id === state.selectedIdea.id);
          if (state.selectedIdea) renderIdeaModal();
        }
      }, err => {
        console.error('Ideas listener error:', err);
        showToast('Connection error. Retrying...');
      });
    }

    // Real-time listener for categories
    function subscribeToCategories() {
      return categoriesRef.onSnapshot(snapshot => {
        state.categories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        render();
      }, err => {
        console.error('Categories listener error:', err);
      });
    }

    // Save a single idea
    async function saveIdea(idea) {
      const { id, ...data } = idea;
      data.updatedAt = Date.now();
      if (id) {
        await ideasRef.doc(id).set(data, { merge: true });
      } else {
        const docRef = await ideasRef.add(data);
        return docRef.id;
      }
    }

    // Delete an idea
    async function deleteIdeaFromDb(ideaId) {
      await ideasRef.doc(ideaId).delete();
    }

    // Save a single category
    async function saveCategory(category) {
      const { id, ...data } = category;
      if (id) {
        await categoriesRef.doc(id).set(data, { merge: true });
      } else {
        const docRef = await categoriesRef.add(data);
        return docRef.id;
      }
    }

    // Initialize default categories if none exist
    async function initializeCategories() {
      const snapshot = await categoriesRef.get();
      if (snapshot.empty) {
        const defaultCategories = [
          { label: 'üöÄ SIDE PROJECTS', color: '#00D9FF' },
          { label: 'üí∞ REVENUE STREAMS', color: '#00FF9F' },
          { label: 'üß† SKILLS & LEARNING', color: '#8B5CF6' },
          { label: 'üîß TOOLS & AUTOMATION', color: '#FF6B35' },
          { label: 'üåê OPEN SOURCE', color: '#FFD700' }
        ];
        for (const cat of defaultCategories) {
          await categoriesRef.add(cat);
        }
      }
    }

    function refreshData() {
      // With real-time sync, just show a visual feedback
      const btn = document.getElementById('refresh-btn');
      btn.classList.add('animate-spin');
      setTimeout(() => btn.classList.remove('animate-spin'), 500);
      showToast('SYSTEMS SYNCHRONIZED');
    }

    // Simple toast notification
    function showToast(message) {
      const existing = document.getElementById('toast');
      if (existing) existing.remove();

      const toast = document.createElement('div');
      toast.id = 'toast';
      toast.className = 'fixed bottom-20 left-1/2 -translate-x-1/2 bg-[#132238] text-[#00D9FF] px-4 py-2 rounded text-xs z-50 border border-[#00D9FF]/30 uppercase tracking-wider font-mono';
      toast.style.boxShadow = '0 0 20px rgba(0, 217, 255, 0.2)';
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(() => toast.remove(), 3000);
    }

    // ==================== INITIALIZATION ====================
    async function initApp() {
      try {
        // Initialize default categories if needed
        await initializeCategories();

        // Subscribe to real-time updates
        subscribeToIdeas();
        subscribeToCategories();

        document.getElementById('loading').classList.add('hidden');
        document.getElementById('main-app').classList.remove('hidden');

        updateAdminButton();
        render();
      } catch (err) {
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('error').classList.remove('hidden');
        document.getElementById('error-message').textContent = err.message;
      }
    }

    function init() {
      // Listen for auth state changes
      auth.onAuthStateChanged((user) => {
        if (user) {
          // Check if user is allowed
          if (!CONFIG.ALLOWED_EMAILS.includes(user.email)) {
            // Not authorized - sign out and show error
            auth.signOut();
            document.getElementById('login-screen').innerHTML = `
              <div class="text-center max-w-md w-full">
                <div class="hud-bracket hud-bracket-amber p-8 bg-[#0F1D32] rounded-lg border border-[#FF6B35]">
                  <div class="text-5xl mb-4">üö´</div>
                  <h2 class="text-xl font-semibold text-[#FF6B35] mb-2 uppercase tracking-wider">ACCESS DENIED</h2>
                  <p class="text-[#4A6B8A] text-sm mb-6">You are not authorized to access this system.</p>
                  <p class="text-[#4A6B8A]/50 text-xs mb-6">${user.email}</p>
                  <button onclick="location.reload()" class="px-6 py-3 bg-[#FF6B35]/20 hover:bg-[#FF6B35]/30 text-[#FF6B35] rounded border border-[#FF6B35]/50 uppercase tracking-wider text-sm">
                    TRY AGAIN
                  </button>
                </div>
              </div>
            `;
            return;
          }
          // User is authorized - show app
          currentUser = user;
          document.getElementById('login-screen').classList.add('hidden');
          document.getElementById('loading').classList.remove('hidden');
          initApp();
        } else {
          // User is signed out - show login
          currentUser = null;
          document.getElementById('login-screen').classList.remove('hidden');
          document.getElementById('loading').classList.add('hidden');
          document.getElementById('main-app').classList.add('hidden');
          document.getElementById('error').classList.add('hidden');
        }
      });
    }

    // ==================== VIEW MANAGEMENT ====================
    function setView(view) {
      state.view = view;
      state.selectedCategoryView = null;
      document.getElementById('btn-pipeline').className = view === 'pipeline'
        ? 'px-2 py-1.5 sm:px-3 sm:py-1.5 rounded text-xs sm:text-sm font-medium transition-colors bg-[#00D9FF]/20 text-[#00D9FF] touch-active uppercase tracking-wider'
        : 'px-2 py-1.5 sm:px-3 sm:py-1.5 rounded text-xs sm:text-sm font-medium transition-colors text-[#4A6B8A] touch-active uppercase tracking-wider';
      document.getElementById('btn-category').className = view === 'category'
        ? 'px-2 py-1.5 sm:px-3 sm:py-1.5 rounded text-xs sm:text-sm font-medium transition-colors bg-[#00D9FF]/20 text-[#00D9FF] touch-active uppercase tracking-wider'
        : 'px-2 py-1.5 sm:px-3 sm:py-1.5 rounded text-xs sm:text-sm font-medium transition-colors text-[#4A6B8A] touch-active uppercase tracking-wider';
      render();
    }

    function setActiveStage(stageId) {
      state.activeStage = stageId;
      render();
      // Scroll active tab into view
      setTimeout(() => {
        const activeTab = document.querySelector(`[data-stage="${stageId}"]`);
        if (activeTab) activeTab.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
      }, 10);
    }

    // ==================== RENDER FUNCTIONS ====================
    function render() {
      const content = document.getElementById('content');
      if (state.view === 'pipeline') {
        content.innerHTML = renderPipelineView();
      } else {
        content.innerHTML = state.selectedCategoryView ? renderCategoryDetail() : renderCategoryView();
      }
    }

    function renderPipelineView() {
      const stageIdeas = state.ideas.filter(i => i.stage === state.activeStage);
      const activeIndex = STAGES.findIndex(s => s.id === state.activeStage);
      const activeStage = STAGES[activeIndex];
      const blockedCount = stageIdeas.filter(i => i.blocked).length;

      // Update objective counter
      setTimeout(() => {
        const counter = document.getElementById('objective-counter');
        if (counter) counter.innerHTML = `TRACKING: <span class="text-[#00D9FF]">${state.ideas.length}</span>/100 OBJECTIVES`;
      }, 0);

      return `
        <div class="flex-shrink-0 bg-[#0F1D32] border-b border-[#1E3A5F]">
          <div class="px-2 sm:px-4">
            <div class="flex items-center justify-center gap-2 sm:gap-4 py-2 sm:py-3">
              ${STAGES.map(stage => {
                const count = state.ideas.filter(i => i.stage === stage.id).length;
                const blocked = state.ideas.filter(i => i.stage === stage.id && i.blocked).length;
                const isActive = state.activeStage === stage.id;
                return `
                  <button data-stage="${stage.id}" onclick="setActiveStage('${stage.id}')" class="stage-tab flex flex-col items-center justify-center px-2 py-1.5 sm:px-3 sm:py-2 rounded whitespace-nowrap transition-all touch-active min-w-[44px] min-h-[44px] ${isActive ? '' : 'text-[#4A6B8A]'} border ${isActive ? 'border-current' : 'border-transparent'}" style="${isActive ? `background-color: ${stage.color}15; color: ${stage.color}; box-shadow: 0 0 10px ${stage.color}30` : ''}">
                    <span class="text-lg sm:text-xl">${stage.emoji}</span>
                    <span class="text-[10px] sm:text-xs mt-0.5 font-mono ${isActive ? 'font-semibold' : 'font-normal'}">${count}${blocked > 0 ? '‚ö†' : ''}</span>
                  </button>
                `;
              }).join('')}
            </div>
          </div>
        </div>

        <!-- Current Stage Header -->
        <div class="flex-shrink-0 px-3 sm:px-4 py-3 bg-[#0A1628] border-b border-[#1E3A5F]">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded flex items-center justify-center text-2xl border" style="background-color: ${activeStage.color}15; border-color: ${activeStage.color}40; box-shadow: 0 0 15px ${activeStage.color}20">
                ${activeStage.emoji}
              </div>
              <div>
                <h2 class="text-lg font-semibold uppercase tracking-wider" style="color: ${activeStage.color}">${activeStage.label}</h2>
                <p class="text-xs text-[#4A6B8A] uppercase tracking-wider">${stageIdeas.length} OBJECTIVE${stageIdeas.length !== 1 ? 'S' : ''}${blockedCount > 0 ? ` ¬∑ ${blockedCount} STALLED` : ''}</p>
              </div>
            </div>
            <div class="flex items-center gap-1">
              <button onclick="navigateStage(-1)" ${activeIndex === 0 ? 'disabled' : ''} class="p-2 rounded text-[#4A6B8A] hover:text-[#00D9FF] hover:bg-[#132238] disabled:opacity-30 disabled:cursor-not-allowed transition-colors touch-active border border-transparent hover:border-[#1E3A5F]">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
              </button>
              <button onclick="navigateStage(1)" ${activeIndex === STAGES.length - 1 ? 'disabled' : ''} class="p-2 rounded text-[#4A6B8A] hover:text-[#00D9FF] hover:bg-[#132238] disabled:opacity-30 disabled:cursor-not-allowed transition-colors touch-active border border-transparent hover:border-[#1E3A5F]">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
              </button>
            </div>
          </div>
        </div>

        <!-- Ideas Content -->
        <div class="flex-1 overflow-y-auto scroll-container px-3 sm:px-4 py-4" id="ideas-scroll">
          <div class="max-w-7xl mx-auto pb-4">
            ${stageIdeas.length === 0 ? `
              <div class="text-center py-16 hud-bracket p-8">
                <div class="text-5xl mb-4">${STAGES[activeIndex].emoji}</div>
                <p class="text-[#4A6B8A] text-lg uppercase tracking-wider">NO OBJECTIVES IN THIS STAGE</p>
                <p class="text-[#4A6B8A]/60 text-sm mt-2 uppercase tracking-wider">${state.activeStage === 'new' ? 'Log your first mission objective' : 'Advance objectives from previous stages'}</p>
                ${state.activeStage === 'new' ? `
                  <button onclick="openSubmitModal()" class="mt-6 px-6 py-3 bg-[#00D9FF]/20 hover:bg-[#00D9FF]/30 text-[#00D9FF] font-semibold rounded transition-all touch-active border border-[#00D9FF]/50 uppercase tracking-wider">
                    + NEW OBJECTIVE
                  </button>
                ` : ''}
              </div>
            ` : `
              <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4">
                ${state.activeStage === 'new' ? `
                  <div onclick="openSubmitModal()" class="hud-card rounded p-4 cursor-pointer hover:border-[#00D9FF]/50 transition-all touch-active min-h-[100px] flex flex-col items-center justify-center text-center border-2 border-dashed border-[#00D9FF]/30">
                    <div class="text-3xl mb-2">üì•</div>
                    <p class="text-[#00D9FF] font-medium uppercase tracking-wider text-sm">+ NEW OBJECTIVE</p>
                    <p class="text-[#4A6B8A] text-xs mt-1 uppercase tracking-wider">Log a mission</p>
                  </div>
                ` : ''}
                ${stageIdeas.sort((a, b) => {
                  // Blocked ideas first
                  if (a.blocked !== b.blocked) return b.blocked - a.blocked;
                  // Then by popularity (upvotes - downvotes)
                  const scoreA = getIdeaScore(a);
                  const scoreB = getIdeaScore(b);
                  if (scoreA !== scoreB) return scoreB - scoreA;
                  // Then by date
                  return (b.createdAt || 0) - (a.createdAt || 0);
                }).map(idea => renderIdeaCard(idea)).join('')}
              </div>
            `}
          </div>
        </div>

      `;
    }

    function renderCategoryView() {
      return `
        <div class="flex-1 overflow-y-auto scroll-container px-3 sm:px-4 py-4">
          <div class="max-w-7xl mx-auto pb-4">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4">
              ${state.categories.map(cat => {
                const catIdeas = state.ideas.filter(i => (i.categories || []).includes(cat.id));
                const blocked = catIdeas.filter(i => i.blocked).length;
                const stageBreakdown = STAGES.map(s => ({ ...s, count: catIdeas.filter(i => i.stage === s.id).length }));
                const maxCount = Math.max(...stageBreakdown.map(s => s.count), 1);
                return `
                  <div onclick="openCategoryDetail('${cat.id}')" class="hud-card rounded p-4 sm:p-5 cursor-pointer transition-all border border-[#1E3A5F] hover:border-[${cat.color}]/50 touch-active">
                    <div class="flex items-start justify-between mb-4">
                      <h3 class="text-sm sm:text-base font-semibold uppercase tracking-wider" style="color: ${cat.color}">${cat.label}</h3>
                      <div class="flex items-center gap-2">
                        ${blocked > 0 ? `<span class="text-[#FF6B35] text-sm">‚ö†${blocked}</span>` : ''}
                        <span class="px-2 py-1 bg-[#0A1628] rounded text-sm font-mono border border-[#1E3A5F]" style="color: ${cat.color}">${catIdeas.length}</span>
                      </div>
                    </div>
                    <div class="space-y-1.5">
                      ${stageBreakdown.map(stage => `
                        <div class="flex items-center gap-2">
                          <span class="text-xs w-5">${stage.emoji}</span>
                          <div class="flex-1 h-1.5 bg-[#0A1628] rounded-full overflow-hidden">
                            <div class="h-full rounded-full transition-all" style="width: ${(stage.count / maxCount) * 100}%; background-color: ${stage.color}; min-width: ${stage.count > 0 ? '8px' : '0'}; box-shadow: 0 0 6px ${stage.color}80"></div>
                          </div>
                          <span class="text-xs text-[#4A6B8A] w-4 text-right font-mono">${stage.count}</span>
                        </div>
                      `).join('')}
                    </div>
                  </div>
                `;
              }).join('')}
              ${state.isAdmin ? `
                <div onclick="openAddCategoryModal()" class="hud-card rounded p-5 cursor-pointer transition-all border-2 border-dashed border-[#1E3A5F] hover:border-[#00D9FF]/50 flex items-center justify-center min-h-[180px] touch-active">
                  <div class="text-center">
                    <div class="text-4xl mb-2 text-[#00D9FF]">+</div>
                    <p class="text-[#4A6B8A] uppercase tracking-wider text-sm">ADD CATEGORY</p>
                  </div>
                </div>
              ` : ''}
            </div>
          </div>
        </div>
      `;
    }

    function renderCategoryDetail() {
      const category = state.categories.find(c => c.id === state.selectedCategoryView);
      if (!category) return '';
      const categoryIdeas = state.ideas.filter(i => (i.categories || []).includes(category.id));

      return `
        <div class="flex flex-col h-full overflow-hidden">
          <div class="flex-shrink-0 bg-[#0F1D32] border-b border-[#1E3A5F]">
            <div class="px-3 sm:px-4 py-3 sm:py-4">
              <button onclick="state.selectedCategoryView = null; render()" class="flex items-center gap-2 text-[#4A6B8A] active:text-[#00D9FF] mb-3 transition-colors touch-active min-h-[44px] uppercase tracking-wider text-sm">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                BACK
              </button>
              <div class="flex items-center gap-3 flex-wrap">
                <span class="px-4 py-2 rounded text-sm sm:text-base font-medium uppercase tracking-wider border" style="background-color: ${category.color}15; color: ${category.color}; border-color: ${category.color}40">${category.label}</span>
                <span class="text-[#4A6B8A] uppercase tracking-wider text-sm">${categoryIdeas.length} OBJECTIVE${categoryIdeas.length !== 1 ? 'S' : ''}</span>
              </div>
            </div>
          </div>
          <div class="flex-1 overflow-y-auto scroll-container px-3 sm:px-4 py-4">
            <div class="max-w-7xl mx-auto pb-4">
              ${categoryIdeas.length === 0 ? `
                <div class="text-center py-16 hud-bracket p-8"><p class="text-[#4A6B8A] uppercase tracking-wider">NO OBJECTIVES IN THIS CATEGORY</p></div>
              ` : `
                <div class="space-y-3">
                  ${categoryIdeas.sort((a, b) => {
                    const scoreA = getIdeaScore(a);
                    const scoreB = getIdeaScore(b);
                    if (scoreA !== scoreB) return scoreB - scoreA;
                    return (b.createdAt || 0) - (a.createdAt || 0);
                  }).map(idea => {
                    const stage = STAGES.find(s => s.id === idea.stage);
                    return `
                      <div onclick="openIdeaModal('${idea.id}')" class="hud-card rounded p-4 cursor-pointer transition-all flex items-center gap-4 touch-active min-h-[72px] border border-[#1E3A5F] hover:border-[#00D9FF]/30">
                        <div class="w-1 h-12 rounded-full flex-shrink-0" style="background-color: ${stage?.color}; box-shadow: 0 0 8px ${stage?.color}60"></div>
                        <div class="flex-1 min-w-0">
                          <div class="flex items-center gap-2 mb-1">
                            <h3 class="font-medium text-[#E0F4FF] truncate">${escapeHtml(idea.title)}</h3>
                            ${idea.blocked ? '<span class="text-[#FF6B35] flex-shrink-0">‚ö†</span>' : ''}
                          </div>
                          <div class="flex items-center gap-2 sm:gap-3 text-sm flex-wrap">
                            <span class="px-2 py-0.5 rounded text-xs uppercase tracking-wider font-mono" style="background-color: ${stage?.color}15; color: ${stage?.color}">${stage?.emoji} ${stage?.label}</span>
                            <span class="text-[#4A6B8A] text-xs uppercase tracking-wider">OP: ${escapeHtml(idea.submitter)}</span>
                          </div>
                        </div>
                        <svg class="w-5 h-5 text-[#4A6B8A] flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                      </div>
                    `;
                  }).join('')}
                </div>
              `}
            </div>
          </div>
        </div>
      `;
    }

    function renderIdeaCard(idea) {
      const stage = STAGES.find(s => s.id === idea.stage) || STAGES[0];
      const ideaCategories = (idea.categories || []).map(catId => state.categories.find(c => c.id === catId)).filter(Boolean);
      const displayCategories = ideaCategories.slice(0, 2);
      const remainingCount = ideaCategories.length - 2;
      const noteCount = (idea.notes || []).length;
      const showLink = idea.link && (idea.stage === 'testing' || idea.stage === 'deployed');
      const score = getIdeaScore(idea);

      return `
        <div onclick="openIdeaModal('${idea.id}')" class="hud-card rounded p-4 cursor-pointer transition-all border-l-2 touch-active min-h-[100px] ${idea.blocked ? 'stalled-glow' : ''} hover:border-[#00D9FF]/30 border border-[#1E3A5F]" style="border-left-color: ${stage.color}; border-left-width: 3px;">
          <div class="flex items-start justify-between gap-2 mb-2">
            <h3 class="font-medium text-[#E0F4FF] line-clamp-2 text-sm sm:text-base">${escapeHtml(idea.title)}</h3>
            <div class="flex items-center gap-1.5 flex-shrink-0">
              ${score !== 0 ? `<span class="text-[10px] sm:text-xs px-1.5 py-0.5 rounded font-mono ${score > 0 ? 'bg-[#00FF9F]/20 text-[#00FF9F]' : 'bg-[#FF6B35]/20 text-[#FF6B35]'}">${score > 0 ? '+' : ''}${score}</span>` : ''}
              ${idea.blocked ? '<span class="text-[#FF6B35]">‚ö†</span>' : ''}
              ${noteCount > 0 ? `<span class="text-[#4A6B8A] text-xs font-mono">üìù${noteCount}</span>` : ''}
            </div>
          </div>
          ${idea.description ? `<p class="text-[#4A6B8A] text-xs sm:text-sm line-clamp-2 mb-3">${escapeHtml(idea.description)}</p>` : ''}
          ${ideaCategories.length > 0 ? `
            <div class="flex flex-wrap gap-1.5 mb-3">
              ${displayCategories.map(cat => `<span class="px-2 py-0.5 rounded text-[10px] sm:text-xs font-medium uppercase tracking-wider" style="background-color: ${cat.color}15; color: ${cat.color}; border: 1px solid ${cat.color}30">${cat.label}</span>`).join('')}
              ${remainingCount > 0 ? `<span class="px-2 py-0.5 rounded text-[10px] sm:text-xs font-medium bg-[#132238] text-[#4A6B8A] border border-[#1E3A5F]">+${remainingCount}</span>` : ''}
            </div>
          ` : ''}
          <div class="flex items-center justify-between text-[10px] sm:text-xs text-[#4A6B8A]">
            <span class="uppercase tracking-wider">OP: ${escapeHtml(idea.submitter)}</span>
            <div class="flex items-center gap-2">
              ${showLink ? `<a href="${escapeHtml(idea.link)}" target="_blank" rel="noopener" onclick="event.stopPropagation()" class="px-2 py-1 bg-[#00FF9F]/20 hover:bg-[#00FF9F]/30 text-[#00FF9F] text-[10px] sm:text-xs font-medium rounded transition-colors border border-[#00FF9F]/50 uppercase tracking-wider">üîó LAUNCH</a>` : ''}
              ${idea.createdAt ? `<span class="font-mono">${new Date(idea.createdAt).toLocaleDateString()}</span>` : ''}
            </div>
          </div>
        </div>
      `;
    }

    // ==================== MODAL FUNCTIONS ====================
    function openSubmitModal() {
      state.selectedCategories = [];
      document.getElementById('submit-form').reset();
      document.getElementById('input-submitter').value = 'Connor';
      document.getElementById('submit-success').classList.add('hidden');
      document.getElementById('submit-form-container').classList.remove('hidden');
      renderCategorySelect();
      document.getElementById('submit-modal').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    function closeSubmitModal() {
      document.getElementById('submit-modal').classList.add('hidden');
      document.body.style.overflow = '';
    }

    function renderCategorySelect() {
      const container = document.getElementById('category-select');
      container.innerHTML = state.categories.map(cat => `
        <button type="button" onclick="toggleCategorySelect('${cat.id}')" class="px-3 py-2 rounded text-xs font-medium transition-all touch-active min-h-[40px] uppercase tracking-wider border ${state.selectedCategories.includes(cat.id) ? 'border-current' : 'border-transparent opacity-60'}" style="background-color: ${cat.color}15; color: ${cat.color};">${cat.label}</button>
      `).join('');
    }

    function toggleCategorySelect(catId) {
      if (state.selectedCategories.includes(catId)) {
        state.selectedCategories = state.selectedCategories.filter(id => id !== catId);
      } else {
        state.selectedCategories.push(catId);
      }
      renderCategorySelect();
    }

    async function submitIdea(e) {
      e.preventDefault();
      const btn = document.getElementById('submit-btn');
      btn.disabled = true;
      btn.textContent = 'Submitting...';

      const submitter = document.getElementById('input-submitter').value.trim();
      const title = document.getElementById('input-title').value.trim();
      const description = document.getElementById('input-description').value.trim();

      if (!submitter || !title) {
        btn.disabled = false;
        btn.textContent = 'Submit';
        return;
      }

      const newIdea = {
        title,
        description,
        submitter,
        stage: 'new',
        categories: [...state.selectedCategories],
        blocked: false,
        blockedReason: '',
        notes: [],
        createdAt: Date.now(),
        updatedAt: Date.now()
      };

      try {
        await ideasRef.add(newIdea);
        document.getElementById('submit-form-container').classList.add('hidden');
        document.getElementById('submit-success').classList.remove('hidden');
        setTimeout(() => {
          closeSubmitModal();
        }, 1500);
      } catch (err) {
        showToast('Failed to submit. Try again.');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Submit';
      }
    }

    function openIdeaModal(ideaId) {
      state.selectedIdea = state.ideas.find(i => i.id === ideaId);
      if (!state.selectedIdea) return;
      renderIdeaModal();
      document.getElementById('idea-modal').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    function closeIdeaModal() {
      document.getElementById('idea-modal').classList.add('hidden');
      document.body.style.overflow = '';
      state.selectedIdea = null;
      state.isEditingIdea = false;
    }

    function renderIdeaModal() {
      const idea = state.selectedIdea;
      if (!idea) return;

      const stage = STAGES.find(s => s.id === idea.stage) || STAGES[0];
      const ideaCategories = (idea.categories || []).map(catId => state.categories.find(c => c.id === catId)).filter(Boolean);
      const availableCategories = state.categories.filter(c => !(idea.categories || []).includes(c.id));

      document.getElementById('idea-modal-content').innerHTML = `
        <!-- Drag handle for mobile -->
        <div class="sm:hidden flex justify-center pt-3 pb-1 flex-shrink-0">
          <div class="w-10 h-1 bg-slate-600 rounded-full"></div>
        </div>

        <!-- Header -->
        <div class="p-4 sm:p-6 border-b border-slate-700 flex-shrink-0">
          <div class="flex items-start justify-between gap-3">
            <div class="flex-1 min-w-0">
              ${state.isEditingIdea ? `
                <input type="text" id="edit-title" value="${escapeHtml(idea.title)}" class="w-full text-lg sm:text-xl font-semibold text-white mb-2 bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
              ` : `
                <h2 class="text-lg sm:text-xl font-semibold text-white mb-2 pr-2">${escapeHtml(idea.title)}</h2>
              `}
              <div class="flex items-center gap-2 flex-wrap">
                <span class="px-3 py-1 rounded-full text-xs sm:text-sm font-medium" style="background-color: ${stage.color}20; color: ${stage.color}">${stage.emoji} ${stage.label}</span>
                ${idea.blocked ? '<span class="px-3 py-1 rounded-full text-xs sm:text-sm font-medium bg-red-500/20 text-red-400">üö© Stalled</span>' : ''}
              </div>
            </div>
            <div class="flex items-center gap-1">
              ${state.isAdmin && !state.isEditingIdea ? `
                <button onclick="startEditIdea()" class="text-slate-400 active:text-blue-400 p-2 touch-active rounded-lg min-w-[44px] min-h-[44px] flex items-center justify-center" title="Edit">
                  <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                </button>
              ` : ''}
              <button onclick="closeIdeaModal()" class="text-slate-400 active:text-white p-2 touch-active rounded-lg min-w-[44px] min-h-[44px] flex items-center justify-center">
                <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
              </button>
            </div>
          </div>
        </div>

        <!-- Scrollable Content -->
        <div class="flex-1 overflow-y-auto scroll-container p-4 sm:p-6 space-y-5 modal-scroll">
          ${state.isEditingIdea ? `
            <div>
              <h3 class="text-xs sm:text-sm font-medium text-slate-400 mb-2">Description</h3>
              <textarea id="edit-description" rows="4" class="w-full text-slate-200 text-sm sm:text-base bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none">${escapeHtml(idea.description || '')}</textarea>
            </div>
            <div class="flex gap-2">
              <button onclick="saveEditIdea('${idea.id}')" class="flex-1 px-4 py-3 bg-blue-600 active:bg-blue-700 text-white text-sm font-medium rounded-xl transition-colors touch-active">Save Changes</button>
              <button onclick="cancelEditIdea()" class="px-4 py-3 bg-slate-700 active:bg-slate-600 text-white text-sm font-medium rounded-xl transition-colors touch-active">Cancel</button>
            </div>
          ` : idea.description ? `
            <div>
              <h3 class="text-xs sm:text-sm font-medium text-slate-400 mb-2">Description</h3>
              <p class="text-slate-200 text-sm sm:text-base whitespace-pre-wrap">${escapeHtml(idea.description)}</p>
            </div>
          ` : ''}

          ${idea.blocked && idea.blockedReason ? `
            <div class="bg-red-500/10 border border-red-500/30 rounded-xl p-4">
              <h3 class="text-xs sm:text-sm font-medium text-red-400 mb-1">Stalled Reason</h3>
              <p class="text-red-300 text-sm">${escapeHtml(idea.blockedReason)}</p>
            </div>
          ` : ''}

          <div>
            <h3 class="text-xs sm:text-sm font-medium text-slate-400 mb-2">Categories</h3>
            <div class="flex flex-wrap gap-2">
              ${ideaCategories.length > 0 ? ideaCategories.map(cat => `
                <span class="px-3 py-1.5 rounded-full text-xs sm:text-sm font-medium inline-flex items-center gap-2" style="background-color: ${cat.color}20; color: ${cat.color}">
                  ${cat.label}
                  ${state.isAdmin ? `<button onclick="removeIdeaCategory('${idea.id}', '${cat.id}')" class="hover:opacity-70 min-w-[20px] min-h-[20px]">√ó</button>` : ''}
                </span>
              `).join('') : '<span class="text-slate-500 text-sm">No categories</span>'}
            </div>
            ${state.isAdmin && availableCategories.length > 0 ? `
              <div class="mt-3">
                <p class="text-xs text-slate-500 mb-2">Add category:</p>
                <div class="flex flex-wrap gap-2">
                  ${availableCategories.map(cat => `
                    <button onclick="addIdeaCategory('${idea.id}', '${cat.id}')" class="px-2 py-1.5 rounded-full text-xs font-medium opacity-50 active:opacity-100 transition-opacity touch-active min-h-[32px]" style="background-color: ${cat.color}20; color: ${cat.color}">+ ${cat.label}</button>
                  `).join('')}
                </div>
              </div>
            ` : ''}
          </div>

          <div class="flex items-center justify-between flex-wrap gap-2">
            <div class="flex items-center gap-4 sm:gap-6 text-xs sm:text-sm text-slate-400 flex-wrap">
              <span>by <span class="text-white">${escapeHtml(idea.submitter)}</span></span>
              ${idea.createdAt ? `<span>${new Date(idea.createdAt).toLocaleDateString()}</span>` : ''}
            </div>
            <div class="flex items-center gap-2">
              <button onclick="voteIdea('${idea.id}', 'up')" class="flex items-center gap-1 px-3 py-2 rounded-lg text-sm transition-colors touch-active ${(idea.votes || []).includes(getVoterId() + ':up') ? 'bg-green-600/30 text-green-400' : 'bg-slate-700 text-slate-400 active:bg-green-600/20'}">
                ü§© <span>${(idea.upvotes || 0)}</span>
              </button>
              <button onclick="voteIdea('${idea.id}', 'down')" class="flex items-center gap-1 px-3 py-2 rounded-lg text-sm transition-colors touch-active ${(idea.votes || []).includes(getVoterId() + ':down') ? 'bg-red-600/30 text-red-400' : 'bg-slate-700 text-slate-400 active:bg-red-600/20'}">
                üòï <span>${(idea.downvotes || 0)}</span>
              </button>
            </div>
          </div>

          <div>
            <h3 class="text-xs sm:text-sm font-medium text-slate-400 mb-3">Notes (${(idea.notes || []).length})</h3>
            <div class="space-y-3">
              ${(idea.notes || []).map(note => `
                <div class="bg-slate-700/50 rounded-xl p-3">
                  <div class="flex items-start justify-between gap-2">
                    <p class="text-slate-200 text-sm">${escapeHtml(note.text)}</p>
                    ${state.isAdmin ? `<button onclick="deleteNote('${idea.id}', '${note.id}')" class="text-slate-500 active:text-red-400 text-xs flex-shrink-0 touch-active min-w-[44px] min-h-[32px]">Delete</button>` : ''}
                  </div>
                  <div class="flex items-center gap-3 mt-2 text-xs text-slate-500">
                    <span>${escapeHtml(note.author)}</span>
                    <span>${new Date(note.date).toLocaleDateString()}</span>
                  </div>
                </div>
              `).join('')}
            </div>
            <div class="mt-4 space-y-2">
              <input type="text" id="note-author" placeholder="Your name" class="w-full px-4 py-3 bg-slate-700 border border-slate-600 rounded-xl text-white placeholder-slate-400 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
              <div class="flex gap-2">
                <input type="text" id="note-text" placeholder="Add a note..." class="flex-1 px-4 py-3 bg-slate-700 border border-slate-600 rounded-xl text-white placeholder-slate-400 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" onkeydown="if(event.key==='Enter')addNote('${idea.id}')">
                <button onclick="addNote('${idea.id}')" class="px-4 py-3 bg-blue-600 active:bg-blue-700 text-white text-sm rounded-xl transition-colors touch-active min-w-[60px]">Add</button>
              </div>
            </div>
          </div>

          ${state.isAdmin ? `
            <div class="border-t border-slate-700 pt-5 space-y-4">
              <div>
                <h3 class="text-xs sm:text-sm font-medium text-slate-400 mb-2">Tool Link</h3>
                <div class="flex gap-2">
                  <input type="url" id="idea-link-${idea.id}" value="${escapeHtml(idea.link || '')}" placeholder="https://..." class="flex-1 px-4 py-3 bg-slate-700 border border-slate-600 rounded-xl text-white placeholder-slate-400 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                  <button onclick="saveIdeaLink('${idea.id}')" class="px-4 py-3 bg-blue-600 active:bg-blue-700 text-white text-sm rounded-xl transition-colors touch-active">Save</button>
                </div>
                <p class="text-xs text-slate-500 mt-1">Link appears on card in Testing & Live stages</p>
              </div>

              <div>
                <h3 class="text-xs sm:text-sm font-medium text-slate-400 mb-2">Move to Stage</h3>
                <div class="flex flex-wrap gap-2">
                  ${STAGES.map(s => `
                    <button onclick="moveIdea('${idea.id}', '${s.id}')" ${s.id === idea.stage ? 'disabled' : ''} class="px-3 py-2 rounded-xl text-xs sm:text-sm font-medium transition-colors touch-active min-h-[40px] ${s.id === idea.stage ? 'bg-slate-600 text-slate-400 cursor-not-allowed' : 'active:opacity-80'}" style="${s.id !== idea.stage ? `background-color: ${s.color}30; color: ${s.color}` : ''}">${s.emoji} ${s.label}</button>
                  `).join('')}
                </div>
              </div>

              <div>
                <h3 class="text-xs sm:text-sm font-medium text-slate-400 mb-2">Status</h3>
                <div id="blocked-controls">
                  ${idea.blocked ? `
                    <button onclick="unblockIdea('${idea.id}')" class="px-4 py-3 rounded-xl text-sm font-medium transition-colors bg-green-600/20 active:bg-green-600/30 text-green-400 touch-active min-h-[48px]">‚úì Unblock Idea</button>
                  ` : `
                    <div id="block-form-${idea.id}" class="hidden flex gap-2 flex-col sm:flex-row">
                      <input type="text" id="block-reason-${idea.id}" placeholder="Reason for blocking..." class="flex-1 px-4 py-3 bg-slate-700 border border-slate-600 rounded-xl text-white placeholder-slate-400 text-sm focus:outline-none focus:ring-2 focus:ring-red-500">
                      <div class="flex gap-2">
                        <button onclick="confirmBlockIdea('${idea.id}')" class="flex-1 sm:flex-none px-4 py-3 bg-red-600 active:bg-red-700 text-white text-sm rounded-xl transition-colors touch-active">Block</button>
                        <button onclick="cancelBlockIdea('${idea.id}')" class="flex-1 sm:flex-none px-4 py-3 bg-slate-700 active:bg-slate-600 text-white text-sm rounded-xl transition-colors touch-active">Cancel</button>
                      </div>
                    </div>
                    <button id="block-btn-${idea.id}" onclick="showBlockForm('${idea.id}')" class="px-4 py-3 rounded-xl text-sm font-medium transition-colors bg-red-600/20 active:bg-red-600/30 text-red-400 touch-active min-h-[48px]">üö© Flag as Stalled</button>
                  `}
                </div>
              </div>

              <div class="safe-bottom">
                <button onclick="deleteIdea('${idea.id}')" id="delete-btn-${idea.id}" class="px-4 py-3 rounded-xl text-sm font-medium transition-colors bg-slate-700 active:bg-slate-600 text-red-400 touch-active min-h-[48px]">Delete Idea</button>
              </div>
            </div>
          ` : '<div class="safe-bottom"></div>'}
        </div>
      `;
    }

    function openAdminModal() {
      document.getElementById('admin-code-input').value = '';
      document.getElementById('admin-error').classList.add('hidden');
      document.getElementById('admin-modal').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      setTimeout(() => document.getElementById('admin-code-input').focus(), 100);
    }

    function closeAdminModal() {
      document.getElementById('admin-modal').classList.add('hidden');
      document.body.style.overflow = '';
    }

    function openBugReportModal() {
      document.getElementById('bug-description').value = '';
      document.getElementById('bug-contact').value = '';
      document.getElementById('bug-modal').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      setTimeout(() => document.getElementById('bug-description').focus(), 100);
    }

    function closeBugReportModal() {
      document.getElementById('bug-modal').classList.add('hidden');
      document.body.style.overflow = '';
    }

    async function submitBugReport(e) {
      e.preventDefault();
      const description = document.getElementById('bug-description').value.trim();
      const contact = document.getElementById('bug-contact').value.trim();

      if (!description) {
        showToast('Please describe the bug');
        return;
      }

      try {
        await db.collection('bugs').add({
          description,
          contact: contact || null,
          createdAt: Date.now(),
          userAgent: navigator.userAgent,
          url: window.location.href,
          resolved: false
        });
        closeBugReportModal();
        showToast('Bug report submitted. Thank you!');
      } catch (err) {
        console.error('Error submitting bug:', err);
        showToast('Failed to submit bug report');
      }
    }

    // Bug List (Admin)
    let bugReports = [];
    let bugsUnsubscribe = null;

    function openBugListModal() {
      if (!state.isAdmin) return;
      document.getElementById('bug-list-modal').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      loadBugReports();
    }

    function closeBugListModal() {
      document.getElementById('bug-list-modal').classList.add('hidden');
      document.body.style.overflow = '';
      if (bugsUnsubscribe) {
        bugsUnsubscribe();
        bugsUnsubscribe = null;
      }
    }

    function loadBugReports() {
      const content = document.getElementById('bug-list-content');
      content.innerHTML = '<div class="text-center text-slate-400 py-8">Loading bug reports...</div>';

      bugsUnsubscribe = db.collection('bugs').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
        bugReports = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderBugList();
      }, err => {
        console.error('Error loading bugs:', err);
        content.innerHTML = '<div class="text-center text-red-400 py-8">Failed to load bug reports</div>';
      });
    }

    function renderBugList() {
      const content = document.getElementById('bug-list-content');

      if (bugReports.length === 0) {
        content.innerHTML = '<div class="text-center text-slate-400 py-8">üéâ No bug reports! Everything is working great.</div>';
        return;
      }

      const unresolvedCount = bugReports.filter(b => !b.resolved).length;

      content.innerHTML = `
        <div class="text-sm text-slate-400 mb-3">${unresolvedCount} unresolved of ${bugReports.length} total</div>
        ${bugReports.map(bug => `
          <div class="bg-slate-700/50 rounded-xl p-4 ${bug.resolved ? 'opacity-60' : ''}">
            <div class="flex items-start justify-between gap-3">
              <div class="flex-1 min-w-0">
                <p class="text-white text-sm whitespace-pre-wrap break-words">${escapeHtml(bug.description)}</p>
                <div class="flex flex-wrap items-center gap-2 mt-2 text-xs text-slate-400">
                  <span>${new Date(bug.createdAt).toLocaleDateString()} ${new Date(bug.createdAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                  ${bug.contact ? `<span class="bg-slate-600 px-2 py-0.5 rounded">üìß ${escapeHtml(bug.contact)}</span>` : ''}
                  ${bug.resolved ? '<span class="bg-green-600/30 text-green-400 px-2 py-0.5 rounded">‚úì Resolved</span>' : '<span class="bg-red-600/30 text-red-400 px-2 py-0.5 rounded">Open</span>'}
                </div>
              </div>
              <div class="flex items-center gap-1 flex-shrink-0">
                <button onclick="toggleBugResolved('${bug.id}', ${!bug.resolved})" class="p-2 ${bug.resolved ? 'text-amber-400 hover:text-amber-300' : 'text-green-400 hover:text-green-300'} transition-colors rounded-lg" title="${bug.resolved ? 'Mark as open' : 'Mark as resolved'}">
                  ${bug.resolved ? '‚Ü©Ô∏è' : '‚úì'}
                </button>
                <button onclick="deleteBug('${bug.id}')" class="p-2 text-red-400 hover:text-red-300 transition-colors rounded-lg" title="Delete bug">
                  üóëÔ∏è
                </button>
              </div>
            </div>
          </div>
        `).join('')}
      `;
    }

    async function toggleBugResolved(bugId, resolved) {
      try {
        await db.collection('bugs').doc(bugId).update({ resolved });
        showToast(resolved ? 'Bug marked as resolved' : 'Bug marked as open');
      } catch (err) {
        console.error('Error updating bug:', err);
        showToast('Failed to update bug');
      }
    }

    async function deleteBug(bugId) {
      if (!confirm('Delete this bug report?')) return;
      try {
        await db.collection('bugs').doc(bugId).delete();
        showToast('Bug report deleted');
      } catch (err) {
        console.error('Error deleting bug:', err);
        showToast('Failed to delete bug');
      }
    }

    function toggleAdmin() {
      if (state.isAdmin) {
        state.isAdmin = false;
        localStorage.removeItem('vortech_admin');
        updateAdminButton();
        render();
        showToast('ADMIN ACCESS REVOKED');
      } else {
        openAdminModal();
      }
    }

    function loginAdmin(e) {
      e.preventDefault();
      const code = document.getElementById('admin-code-input').value;
      if (code === CONFIG.ADMIN_CODE) {
        state.isAdmin = true;
        localStorage.setItem('vortech_admin', 'true');
        closeAdminModal();
        updateAdminButton();
        render();
        showToast('ADMIN ACCESS GRANTED');
      } else {
        document.getElementById('admin-error').classList.remove('hidden');
        document.getElementById('admin-code-input').value = '';
      }
    }

    function updateAdminButton() {
      const btn = document.getElementById('btn-admin');
      const bugListBtn = document.getElementById('btn-bug-list');
      if (state.isAdmin) {
        btn.innerHTML = '<span class="sm:hidden">üîì</span><span class="hidden sm:inline">EXIT ADMIN</span>';
        btn.className = 'px-2.5 py-2 sm:px-3 sm:py-2 bg-[#FF6B35]/20 active:bg-[#FF6B35]/30 text-[#FF6B35] text-xs sm:text-sm font-medium rounded transition-colors border border-[#FF6B35]/50 touch-active uppercase tracking-wider';
        bugListBtn.classList.remove('hidden');
      } else {
        btn.innerHTML = '<span class="sm:hidden">‚öôÔ∏è</span><span class="hidden sm:inline">ADMIN</span>';
        btn.className = 'px-2.5 py-2 sm:px-3 sm:py-2 bg-[#132238] active:bg-[#1E3A5F] text-[#4A6B8A] text-xs sm:text-sm font-medium rounded transition-colors touch-active border border-[#1E3A5F] uppercase tracking-wider';
        bugListBtn.classList.add('hidden');
      }
    }

    function openCategoryDetail(catId) {
      state.selectedCategoryView = catId;
      render();
    }

    function openAddCategoryModal() {
      const label = prompt('Enter category label (e.g., "üìä Analytics"):');
      if (!label || !label.trim()) return;
      const colors = ['#EC4899', '#8B5CF6', '#10B981', '#F59E0B', '#6366F1', '#06B6D4', '#EF4444'];
      const color = colors[Math.floor(Math.random() * colors.length)];
      addCategory(label.trim(), color);
    }

    // ==================== DATA OPERATIONS ====================
    async function moveIdea(ideaId, newStage) {
      try {
        await ideasRef.doc(ideaId).update({
          stage: newStage,
          updatedAt: Date.now()
        });
        showToast('OBJECTIVE RELOCATED');
      } catch (err) {
        showToast('Failed to move. Try again.');
      }
    }

    function showBlockForm(ideaId) {
      document.getElementById(`block-btn-${ideaId}`).classList.add('hidden');
      document.getElementById(`block-form-${ideaId}`).classList.remove('hidden');
      document.getElementById(`block-reason-${ideaId}`).focus();
    }

    function cancelBlockIdea(ideaId) {
      document.getElementById(`block-btn-${ideaId}`).classList.remove('hidden');
      document.getElementById(`block-form-${ideaId}`).classList.add('hidden');
    }

    async function confirmBlockIdea(ideaId) {
      const reason = document.getElementById(`block-reason-${ideaId}`).value.trim();
      try {
        await ideasRef.doc(ideaId).update({
          blocked: true,
          blockedReason: reason,
          updatedAt: Date.now()
        });
        showToast('Idea marked as stalled');
      } catch (err) {
        showToast('Failed. Try again.');
      }
    }

    async function unblockIdea(ideaId) {
      try {
        await ideasRef.doc(ideaId).update({
          blocked: false,
          blockedReason: '',
          updatedAt: Date.now()
        });
        showToast('Stall removed');
      } catch (err) {
        showToast('Failed. Try again.');
      }
    }

    async function addNote(ideaId) {
      const author = document.getElementById('note-author').value.trim();
      const text = document.getElementById('note-text').value.trim();
      if (!author || !text) {
        showToast('Enter name and note');
        return;
      }

      const idea = state.ideas.find(i => i.id === ideaId);
      if (!idea) return;

      const note = { id: generateId(), text, author, date: Date.now() };
      const notes = [...(idea.notes || []), note];

      try {
        await ideasRef.doc(ideaId).update({
          notes: notes,
          updatedAt: Date.now()
        });
        document.getElementById('note-author').value = '';
        document.getElementById('note-text').value = '';
        showToast('LOG ENTRY ADDED');
      } catch (err) {
        showToast('Failed. Try again.');
      }
    }

    async function deleteNote(ideaId, noteId) {
      const idea = state.ideas.find(i => i.id === ideaId);
      if (!idea) return;

      const notes = (idea.notes || []).filter(n => n.id !== noteId);

      try {
        await ideasRef.doc(ideaId).update({
          notes: notes,
          updatedAt: Date.now()
        });
        showToast('Note deleted');
      } catch (err) {
        showToast('Failed. Try again.');
      }
    }

    async function addIdeaCategory(ideaId, catId) {
      const idea = state.ideas.find(i => i.id === ideaId);
      if (!idea) return;
      const categories = [...(idea.categories || []), catId];
      try {
        await ideasRef.doc(ideaId).update({
          categories: categories,
          updatedAt: Date.now()
        });
      } catch (err) {
        showToast('Failed. Try again.');
      }
    }

    async function removeIdeaCategory(ideaId, catId) {
      const idea = state.ideas.find(i => i.id === ideaId);
      if (!idea) return;
      const categories = (idea.categories || []).filter(c => c !== catId);
      try {
        await ideasRef.doc(ideaId).update({
          categories: categories,
          updatedAt: Date.now()
        });
      } catch (err) {
        showToast('Failed. Try again.');
      }
    }

    async function saveIdeaLink(ideaId) {
      const link = document.getElementById(`idea-link-${ideaId}`).value.trim();
      try {
        await ideasRef.doc(ideaId).update({
          link: link,
          updatedAt: Date.now()
        });
        showToast(link ? 'Link saved' : 'Link removed');
      } catch (err) {
        showToast('Failed. Try again.');
      }
    }

    async function deleteIdea(ideaId) {
      const btn = document.getElementById(`delete-btn-${ideaId}`);
      if (btn.dataset.confirm !== 'true') {
        btn.dataset.confirm = 'true';
        btn.textContent = 'Tap again to confirm';
        btn.className = 'px-4 py-3 rounded-xl text-sm font-medium transition-colors bg-red-600 active:bg-red-700 text-white touch-active min-h-[48px]';
        return;
      }

      try {
        await ideasRef.doc(ideaId).delete();
        closeIdeaModal();
        showToast('OBJECTIVE TERMINATED');
      } catch (err) {
        showToast('Failed. Try again.');
      }
    }

    function startEditIdea() {
      state.isEditingIdea = true;
      renderIdeaModal();
    }

    function cancelEditIdea() {
      state.isEditingIdea = false;
      renderIdeaModal();
    }

    async function saveEditIdea(ideaId) {
      const title = document.getElementById('edit-title').value.trim();
      const description = document.getElementById('edit-description').value.trim();

      if (!title) {
        showToast('Title is required');
        return;
      }

      try {
        await ideasRef.doc(ideaId).update({
          title: title,
          description: description,
          updatedAt: Date.now()
        });
        state.isEditingIdea = false;
        showToast('OBJECTIVE UPDATED');
      } catch (err) {
        showToast('Failed. Try again.');
      }
    }

    async function addCategory(label, color) {
      try {
        await categoriesRef.add({ label, color });
        showToast('CATEGORY REGISTERED');
      } catch (err) {
        showToast('Failed. Try again.');
      }
    }

    // ==================== VOTING ====================
    function getVoterId() {
      let voterId = localStorage.getItem('vortech_voter_id');
      if (!voterId) {
        voterId = 'voter_' + Math.random().toString(36).substr(2, 9) + Date.now().toString(36);
        localStorage.setItem('vortech_voter_id', voterId);
      }
      return voterId;
    }

    async function voteIdea(ideaId, voteType) {
      const idea = state.ideas.find(i => i.id === ideaId);
      if (!idea) return;

      const voterId = getVoterId();
      const votes = idea.votes || [];
      const existingUpVote = votes.indexOf(voterId + ':up');
      const existingDownVote = votes.indexOf(voterId + ':down');

      let newVotes = [...votes];
      let upvotes = idea.upvotes || 0;
      let downvotes = idea.downvotes || 0;

      // Remove existing vote if any
      if (existingUpVote !== -1) {
        newVotes.splice(existingUpVote, 1);
        upvotes--;
      }
      if (existingDownVote !== -1) {
        newVotes.splice(newVotes.indexOf(voterId + ':down'), 1);
        downvotes--;
      }

      // Add new vote if not toggling off same vote
      if (voteType === 'up' && existingUpVote === -1) {
        newVotes.push(voterId + ':up');
        upvotes++;
      } else if (voteType === 'down' && existingDownVote === -1) {
        newVotes.push(voterId + ':down');
        downvotes++;
      }

      try {
        await ideasRef.doc(ideaId).update({
          votes: newVotes,
          upvotes: upvotes,
          downvotes: downvotes,
          updatedAt: Date.now()
        });
      } catch (err) {
        showToast('Failed to vote. Try again.');
      }
    }

    function getIdeaScore(idea) {
      return (idea.upvotes || 0) - (idea.downvotes || 0);
    }

    function navigateStage(direction) {
      const currentIndex = STAGES.findIndex(s => s.id === state.activeStage);
      const newIndex = currentIndex + direction;
      if (newIndex >= 0 && newIndex < STAGES.length) {
        state.activeStage = STAGES[newIndex].id;
        render();
      }
    }

    // ==================== UTILITIES ====================
    function generateId() {
      return Math.random().toString(36).substr(2, 9) + Date.now().toString(36);
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ==================== TOUCH/SWIPE HANDLING ====================
    let touchStartX = null;
    let touchStartY = null;
    let touchStartTime = null;

    document.addEventListener('touchstart', e => {
      touchStartX = e.touches[0].clientX;
      touchStartY = e.touches[0].clientY;
      touchStartTime = Date.now();
    }, { passive: true });

    document.addEventListener('touchend', e => {
      if (touchStartX === null || state.view !== 'pipeline') return;

      const touchEndX = e.changedTouches[0].clientX;
      const touchEndY = e.changedTouches[0].clientY;
      const diffX = touchStartX - touchEndX;
      const diffY = touchStartY - touchEndY;
      const timeDiff = Date.now() - touchStartTime;

      // Only trigger swipe if:
      // - Horizontal movement > 80px
      // - Horizontal movement > vertical movement (not scrolling)
      // - Swipe completed in under 500ms
      // - Not in a modal
      if (Math.abs(diffX) > 80 && Math.abs(diffX) > Math.abs(diffY) * 1.5 && timeDiff < 500) {
        const modal = document.querySelector('.modal-backdrop:not(.hidden)');
        if (!modal) {
          navigateStage(diffX > 0 ? 1 : -1);
        }
      }

      touchStartX = null;
      touchStartY = null;
      touchStartTime = null;
    }, { passive: true });

    // ==================== KEYBOARD HANDLING ====================
    document.addEventListener('keydown', e => {
      // Close modals on Escape
      if (e.key === 'Escape') {
        const submitModal = document.getElementById('submit-modal');
        const adminModal = document.getElementById('admin-modal');
        const ideaModal = document.getElementById('idea-modal');

        if (!submitModal.classList.contains('hidden')) closeSubmitModal();
        else if (!adminModal.classList.contains('hidden')) closeAdminModal();
        else if (!ideaModal.classList.contains('hidden')) closeIdeaModal();
      }

      // Navigate stages with arrow keys (when no modal open)
      if (state.view === 'pipeline' && !document.querySelector('.modal-backdrop:not(.hidden)')) {
        if (e.key === 'ArrowLeft') navigateStage(-1);
        else if (e.key === 'ArrowRight') navigateStage(1);
      }
    });

    // ==================== OFFLINE HANDLING ====================
    function updateOfflineStatus() {
      state.isOffline = !navigator.onLine;
      const banner = document.getElementById('offline-banner');
      if (state.isOffline) {
        banner.classList.remove('hidden');
      } else {
        banner.classList.add('hidden');
        // Firebase syncs automatically when back online
      }
    }

    window.addEventListener('online', updateOfflineStatus);
    window.addEventListener('offline', updateOfflineStatus);

    // ==================== SERVICE WORKER ====================
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js')
        .then(reg => {
          console.log('Service Worker registered:', reg.scope);
          // Check for updates
          reg.addEventListener('updatefound', () => {
            const newWorker = reg.installing;
            newWorker.addEventListener('statechange', () => {
              if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                showToast('Update available! Refresh to update.');
              }
            });
          });
        })
        .catch(err => console.log('SW registration failed:', err));
    }

    // Initialize
    init();
    updateOfflineStatus();
  </script>
</body>
</html>
